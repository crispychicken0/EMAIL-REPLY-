<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dispute Management System - Crispy Chicken</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #e53935;
    --primary-dark: #c62828;
    --secondary: #ffb300;
    --secondary-dark: #ff8f00;
    --success: #43a047;
    --info: #1e88e5;
    --warning: #fb8c00;
    --danger: #e53935;
    --light: #f5f5f5;
    --dark: #212121;
    --gray: #757575;
    --white: #ffffff;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --radius: 8px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    direction: ltr;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  header {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 25px;
    margin-bottom: 25px;
    text-align: center;
    border-left: 5px solid var(--primary);
  }

  h1 {
    color: var(--primary-dark);
    margin-bottom: 10px;
    font-size: 28px;
  }

  .subtitle {
    color: var(--gray);
    font-size: 16px;
  }

  .card {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px;
    margin-bottom: 25px;
    transition: transform 0.3s ease;
  }

  .card:hover {
    transform: translateY(-2px);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-title i {
    color: var(--primary);
  }

  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }

  .stat-card {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background: var(--primary);
  }

  .stat-card:hover {
    transform: translateY(-5px);
  }

  .stat-icon {
    font-size: 32px;
    margin-bottom: 10px;
    color: var(--primary);
  }

  .stat-value {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 5px;
    color: var(--dark);
  }

  .stat-label {
    font-size: 14px;
    color: var(--gray);
  }

  .form-group {
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: var(--dark);
  }

  input, textarea, select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: var(--radius);
    font-size: 14px;
    transition: border 0.3s ease;
  }

  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.2);
  }

  textarea {
    min-height: 120px;
    resize: vertical;
  }

  .missing-field {
    border-color: var(--danger) !important;
    background-color: #fff8f8 !important;
  }

  .required-indicator {
    color: var(--danger);
    margin-right: 3px;
  }

  .btn {
    display: inline-block;
    padding: 10px 20px;
    background: var(--primary);
    color: var(--white);
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .btn-secondary {
    background: var(--secondary);
  }

  .btn-secondary:hover {
    background: var(--secondary-dark);
  }

  .btn-success {
    background: var(--success);
  }

  .btn-success:hover {
    background: #2e7d32;
  }

  .btn-info {
    background: var(--info);
  }

  .btn-info:hover {
    background: #1565c0;
  }

  .btn-warning {
    background: var(--warning);
  }

  .btn-warning:hover {
    background: #ef6c00;
  }

  .btn-danger {
    background: var(--danger);
  }

  .btn-danger:hover {
    background: #c62828;
  }

  .btn-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .table-container {
    overflow-x: auto;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: var(--white);
  }

  th, td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }

  th {
    background: #f8f9fa;
    font-weight: 600;
    color: var(--dark);
    position: sticky;
    top: 0;
  }

  tr:hover {
    background: #f8f9fa;
  }

  .highlight-row {
    background-color: #fff8e1 !important;
  }

  .status-badge, .evidence-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }

  .status-pending {
    background: #fff3cd;
    color: #856404;
  }

  .status-approved {
    background: #d4edda;
    color: #155724;
  }

  .status-rejected {
    background: #f8d7da;
    color: #721c24;
  }

  .evidence-available {
    background: #d4edda;
    color: #155724;
  }

  .evidence-none {
    background: #f8d7da;
    color: #721c24;
  }

  .action-btn {
    padding: 5px 10px;
    margin: 0 2px;
    background: var(--light);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
  }

  .action-btn:hover {
    background: var(--gray);
    color: var(--white);
  }

  .reasons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }

  .reason-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: var(--radius);
    border: 1px solid #eee;
    transition: all 0.3s ease;
  }

  .reason-item:hover {
    background: #e9ecef;
    border-color: var(--primary);
  }

  .reason-item input {
    width: auto;
    margin-right: 10px;
  }

  .reason-text {
    flex: 1;
  }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: var(--white);
    color: var(--dark);
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
    align-items: center;
    gap: 10px;
    max-width: 350px;
    border-left: 4px solid var(--success);
  }

  .notification.error {
    border-left-color: var(--danger);
  }

  .notification.warning {
    border-left-color: var(--warning);
  }

  .notification i {
    font-size: 20px;
  }

  .notification.error i {
    color: var(--danger);
  }

  .notification.warning i {
    color: var(--warning);
  }

  .notification.success i {
    color: var(--success);
  }

  .filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }

  .copy-ok {
    color: var(--success);
    font-weight: 600;
    margin-left: 10px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }

  .response-textarea {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .response-textarea .form-group {
    margin-bottom: 0;
  }

  @media (max-width: 768px) {
    .form-grid, .filter-grid {
      grid-template-columns: 1fr;
    }
    
    .response-textarea {
      grid-template-columns: 1fr;
    }
    
    .stats-container {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .btn-group {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><i class="fas fa-utensils"></i> Dispute Management System</h1>
    <p class="subtitle">Crispy Chicken - Efficiently handle customer disputes across all platforms</p>
  </header>

  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-clipboard-list"></i></div>
      <div class="stat-value" id="totalDisputes">0</div>
      <div class="stat-label">Total Disputes</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-clock"></i></div>
      <div class="stat-value" id="pendingDisputes">0</div>
      <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
      <div class="stat-value" id="approvedDisputes">0</div>
      <div class="stat-label">Approved</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
      <div class="stat-value" id="rejectedDisputes">0</div>
      <div class="stat-label">Rejected</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
      <div class="stat-value" id="totalRefunded">0</div>
      <div class="stat-label">Total Refunded (AED)</div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-filter"></i> Filter Disputes</div>
    </div>
    <div class="filter-grid">
      <div class="form-group">
        <label for="filterPlatform">Platform:</label>
        <select id="filterPlatform">
          <option value="">All Platforms</option>
          <option value="Noon">Noon</option>
          <option value="Careem">Careem</option>
          <option value="Talabat">Talabat</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label for="filterStatus">Status:</label>
        <select id="filterStatus">
          <option value="">All Statuses</option>
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
        </select>
      </div>
      <div class="form-group">
        <label for="filterEvidence">Evidence:</label>
        <select id="filterEvidence">
          <option value="">All</option>
          <option value="None">No Evidence</option>
          <option value="Available">Available</option>
        </select>
      </div>
      <div class="form-group">
        <label for="searchBox">Search:</label>
        <input type="text" id="searchBox" class="search-box" placeholder="Search by Order ID, Branch, or Issue">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-envelope"></i> Add New Dispute</div>
    </div>
    <div class="form-group">
      <label for="emailText">Email Content:</label>
      <textarea id="emailText" placeholder="Paste the complete email content from Noon / Careem ...">Dear Noon Support Team,
I hope you are well. I am writing about Order FF9BNNCNBM02XFA(Reference: 8229, Subtotal: AED 45.00), placed at Crispy Chicken ‒ Al Barsha, Dubai on 2025-09-09 at 17:56:11.</textarea>
    </div>
    <div class="btn-group">
      <button id="parseBtn" class="btn"><i class="fas fa-magic"></i> Extract & Add</button>
      <button id="clearBtn" class="btn btn-secondary"><i class="fas fa-eraser"></i> Clear</button>
      <div class="form-group" style="margin: 0; min-width: 200px;">
        <label for="platformSelect">Platform (optional):</label>
        <select id="platformSelect">
          <option value="">-- Auto Detect --</option>
          <option value="Noon">Noon</option>
          <option value="Careem">Careem</option>
          <option value="Talabat">Talabat</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div style="margin-left: auto; display: flex; gap: 10px;">
        <button id="downloadCsv" class="btn btn-info"><i class="fas fa-download"></i> Export CSV</button>
        <button id="saveToLocal" class="btn btn-success"><i class="fas fa-save"></i> Save</button>
        <button id="loadFromLocal" class="btn btn-warning"><i class="fas fa-upload"></i> Load</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-edit"></i> Dispute Details</div>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label for="branchName">Branch name:</label>
        <input type="text" id="branchName" placeholder="Branch name">
      </div>
      <div class="form-group">
        <label for="orderDate">Order Date:</label>
        <input type="date" id="orderDate" placeholder="Order date">
      </div>
      <div class="form-group">
        <label for="orderNumber">Order Number:</label>
        <input type="text" id="orderNumber" placeholder="Order number">
      </div>
      <div class="form-group">
        <label for="orderReference">Order Reference:</label>
        <input type="text" id="orderReference" placeholder="Order reference">
      </div>
      <div class="form-group">
        <label for="orderSubtotal">Order Subtotal:</label>
        <input type="text" id="orderSubtotal" placeholder="Subtotal">
      </div>
      <div class="form-group">
        <label for="adjustmentAmount">Adjustment amount:<span class="required-indicator">*</span></label>
        <input type="text" id="adjustmentAmount" placeholder="Compensation amount" class="missing-field">
      </div>
      <div class="form-group">
        <label for="adjustmentReason">Adjustment reason:</label>
        <input type="text" id="adjustmentReason" placeholder="Compensation reason">
      </div>
      <div class="form-group">
        <label for="complaintId">Complaint ID:</label>
        <input type="text" id="complaintId" placeholder="Complaint ID">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-table"></i> Dispute Records</div>
    </div>
    <div class="table-container">
      <table id="disputeTable" class="dispute-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Platform</th>
            <th>Order ID</th>
            <th>Branch</th>
            <th>Order Date</th>
            <th>Order Reference</th>
            <th>Order Subtotal</th>
            <th>Adjustment Amount</th>
            <th>Adjustment Reason</th>
            <th>Complaint ID</th>
            <th>Issue</th>
            <th>Evidence</th>
            <th>Status</th>
            <th>Refunded</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-exclamation-circle"></i> Rejection Reasons</div>
    </div>
    <div class="reasons-grid" id="reasonsGrid">
      <div class="reason-item">
        <input type="checkbox" id="reason1" value="noEvidence">
        <label for="reason1" class="reason-text">Complaint without photographic evidence</label>
      </div>
      <div class="reason-item">
        <input type="checkbox" id="reason2" value="driverNegligence">
        <label for="reason2" class="reason-text">Driver negligence not restaurant responsibility</label>
      </div>
      <div class="reason-item">
        <input type="checkbox" id="reason3" value="videoEvidence">
        <label for="reason3" class="reason-text">Order delivered in full with video evidence</label>
      </div>
      <div class="reason-item">
        <input type="checkbox" id="reason4" value="itemMissing">
        <label for="reason4" class="reason-text">Item missing</label>
      </div>
      <div class="reason-item">
        <input type="checkbox" id="reason5" value="spilledDrink">
        <label for="reason5" class="reason-text">Spilled drink</label>
      </div>
      <div class="reason-item">
        <input type="checkbox" id="reason6" value="wrongOrder">
        <label for="reason6" class="reason-text">Wrong order</label>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title"><i class="fas fa-reply"></i> Response Templates</div>
    </div>
    <div class="btn-group">
      <button id="evidenceBtn" class="btn btn-info"><i class="fas fa-camera"></i> Reply with Evidence</button>
      <button id="noEvidenceBtn" class="btn btn-danger"><i class="fas fa-ban"></i> Reply based on No Evidence</button>
      <button id="driverBtn" class="btn btn-warning"><i class="fas fa-car"></i> Reply Driver Negligence</button>
      <button id="customReplyBtn" class="btn btn-secondary"><i class="fas fa-edit"></i> Custom Reply</button>
    </div>
    
    <h3 style="margin: 20px 0 15px; font-size: 16px; color: var(--dark);">Generated Replies:</h3>
    
    <div class="response-textarea">
      <div class="form-group">
        <label for="replyAr">Reply in Arabic:</label>
        <textarea id="replyAr" style="height:150px"></textarea>
        <div style="margin-top:10px">
          <button id="copyAr" class="btn btn-success"><i class="fas fa-copy"></i> Copy Arabic</button>
          <span id="copiedAr" class="copy-ok" style="display:none">Copied!</span>
        </div>
      </div>
      <div class="form-group">
        <label for="replyEn">Reply in English:</label>
        <textarea id="replyEn" style="height:150px"></textarea>
        <div style="margin-top:10px">
          <button id="copyEn" class="btn btn-success"><i class="fas fa-copy"></i> Copy English</button>
          <span id="copiedEn" class="copy-ok" style="display:none">Copied!</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="notification" class="notification">
  <i class="fas fa-check-circle"></i>
  <span class="notification-text"></span>
</div>

<script>
(function(){
  const emailText = document.getElementById('emailText');
  const parseBtn = document.getElementById('parseBtn');
  const disputeBody = document.querySelector('#disputeTable tbody');
  const platformSelect = document.getElementById('platformSelect');
  const replyAr = document.getElementById('replyAr');
  const replyEn = document.getElementById('replyEn');
  const reasonsGrid = document.getElementById('reasonsGrid');
  const evidenceBtn = document.getElementById('evidenceBtn');
  const noEvidenceBtn = document.getElementById('noEvidenceBtn');
  const driverBtn = document.getElementById('driverBtn');
  const customReplyBtn = document.getElementById('customReplyBtn');
  const notification = document.getElementById('notification');
  const notificationText = document.querySelector('.notification-text');
  const searchBox = document.getElementById('searchBox');
  const filterPlatform = document.getElementById('filterPlatform');
  const filterStatus = document.getElementById('filterStatus');
  const filterEvidence = document.getElementById('filterEvidence');
  
  // Form elements
  const branchNameInput = document.getElementById('branchName');
  const orderDateInput = document.getElementById('orderDate');
  const orderNumberInput = document.getElementById('orderNumber');
  const orderReferenceInput = document.getElementById('orderReference');
  const orderSubtotalInput = document.getElementById('orderSubtotal');
  const adjustmentAmountInput = document.getElementById('adjustmentAmount');
  const adjustmentReasonInput = document.getElementById('adjustmentReason');
  const complaintIdInput = document.getElementById('complaintId');
  
  let disputes = [];
  let currentDispute = null;
  let filteredDisputes = [];
  
  // Sample dispute data
  const sampleDispute = {
    platform: 'Noon',
    orderId: 'FF9ANN275917YZA',
    branch: 'Crispy Chicken - Al Barsha',
    orderDate: '2025-09-10',
    orderReference: '2199',
    orderSubtotal: '30.00',
    adjustmentAmount: 'a',
    adjustmentReason: 'Wrong order or item delivered - Outlet',
    complaintId: 'COMP12345',
    issue: 'Wrong order or item delivered',
    evidence: 'None',
    status: 'Pending',
    refunded: '',
    original: '',
    id: Date.now()
  };
  
  // Reasons data with Arabic and English responses
  const reasonsData = {
    noEvidence: {
      ar: "الشكوى مقدمة بدون أي إثبات صوري يوضح وجود مشكلة في الطلب.",
      en: "The complaint was submitted without any photographic evidence showing an issue with the order."
    },
    driverNegligence: {
      ar: "أي إهمال من جانب السائق أثناء التوصيل لا يعتبر مسؤولية المطعم.",
      en: "Any negligence by the driver during delivery is not the restaurant's responsibility."
    },
    videoEvidence: {
      ar: "تم تسليم الطلب بالكامل للسائق مع وجود فيديو يوضح عملية التسليم كاملة.",
      en: "The order was fully delivered to the driver with video evidence showing the complete handover process."
    },
    itemMissing: {
      ar: "الطلب تم تجهيزه بالكامل وفقاً للطلب الأصلي، ولم يفقد أي صنف.",
      en: "The order was prepared completely according to the original request, and no items were missing."
    },
    spilledDrink: {
      ar: "المشروبات تم تعبئتها بإحكام وأغلقت بشكل صحيح، وأي تسرب يحدث أثناء التوصيل يعتبر مسؤولية السائق.",
      en: "Drinks were sealed tightly and closed properly, any spillage during delivery is the driver's responsibility."
    },
    wrongOrder: {
      ar: "الطلب تم تجهيزه بالضبط حسب الطلب المسجل في النظام، وأي خطأ في التسليم يرجع للسائق.",
      en: "The order was prepared exactly as recorded in the system, any delivery error is the driver's responsibility."
    }
  };
  
  // Enhanced extraction functions
  function extractFields(text){
    const lower = text.toLowerCase();
    const result = {
      platform: '',
      order: '',
      branch: '',
      date: '',
      amount: '',
      complaint: '',
      issue: '',
      original: text.trim(),
      orderReference: '',
      orderSubtotal: '',
      adjustmentReason: '',
      customerName: '',
      customerPhone: '',
      items: []
    };
    
    // Platform
    if(lower.includes('noon')) result.platform = 'Noon';
    if(lower.includes('careem')) result.platform = 'Careem';
    if(lower.includes('talabat')) result.platform = 'Talabat';
    
    // Order number - enhanced patterns
    const orderPatterns = [
      /Order\s*(Number|No|#)?\s*[:\-]?\s*([A-Z0-9\-]{5,30})/i,
      /Order\s*Reference\s*[:\-]?\s*([0-9A-Z\-]{3,30})/i,
      /Order\s*[:\-]\s*([0-9A-Z\-]{3,30})/i,
      /\b([A-Z]{2}\d{4,}[A-Z0-9]*)\b/, // e.g. FF5QNNDQ...
      /\b(order\s*#\s*\d{3,10})/i,
      /\bRef[:\s]*([0-9A-Z\-]{3,30})\b/i,
      /\bID[:\s]*([0-9A-Z\-]{3,30})\b/i
    ];
    
    for(const p of orderPatterns){
      const mm = text.match(p);
      if(mm){
        const val = mm[2] || mm[1];
        if(val) { 
          result.order = val.trim(); 
          break; 
        }
      }
    }
    
    // Branch - enhanced patterns
    const b = text.match(/Branch\s*(name)?\s*[:\-]?\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(b) result.branch = b[2].trim();
    
    const out = text.match(/Outlet\s*[:\-]?\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(out && !result.branch) result.branch = out[1].trim();
    
    const loc = text.match(/Location\s*[:\-]?\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(loc && !result.branch) result.branch = loc[1].trim();
    
    // New pattern for "placed at"
    const placedAt = text.match(/placed at\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(placedAt && !result.branch) result.branch = placedAt[1].trim();
    
    // Date - enhanced patterns
    const d = text.match(/(\d{4}-\d{2}-\d{2})|(\d{2}\/\d{2}\/\d{4})|(\d{4}\/\d{2}\/\d{2})/);
    if(d) result.date = d[0];
    
    // Date with time pattern
    const dateTimeMatch = text.match(/(\d{4}-\d{2}-\d{2})\s*at\s*(\d{2}:\d{2}:\d{2})/);
    if(dateTimeMatch) {
      result.date = dateTimeMatch[1];
    }
    
    // Amount - enhanced patterns
    const a = text.match(/([AED]{1,3}\s*[\d,]+(?:\.\d{1,2})?)|([\d,]+(?:\.\d{1,2})?\s*(AED|Aed|aed|د.إ|درهم))/i);
    if(a) result.amount = a[0].replace(/[:,]/g,'').trim();
    
    // Adjustment amount - if explicitly mentioned and valid
    const adjAmountMatch = text.match(/Adjustment amount\s*[:\-]?\s*([AED\s]*[\d,]+(?:\.\d{1,2})?)/i);
    if(adjAmountMatch) {
      result.amount = adjAmountMatch[1].trim();
    }
    
    // Complaint ID - enhanced patterns
    const c = text.match(/(Complaint|Report|Complaint ID|Customer Complaint|Ticket ID)\s*[:\-]?\s*([A-Z0-9\-]{2,30})/i);
    if(c) result.complaint = (c[2]||c[1]).trim();
    
    // Order Reference
    const ref = text.match(/(Reference|Ref)\s*[:\-]?\s*([A-Z0-9\-]{3,30})/i);
    if(ref) result.orderReference = ref[2].trim();
    
    // Order Subtotal
    const sub = text.match(/(Subtotal|Total)\s*[:\-]?\s*([AED\s]*[\d,]+(?:\.\d{1,2})?)/i);
    if(sub) result.orderSubtotal = sub[2].trim();
    
    // Adjustment Reason
    const adj = text.match(/(Adjustment reason|Reason|Issue)\s*[:\-]?\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(adj) result.adjustmentReason = adj[2].trim();
    
    // Customer Name
    const name = text.match(/(Customer|Client|Name)\s*[:\-]?\s*([A-Za-z\u0600-\u06FF\s]{2,30})/i);
    if(name) result.customerName = name[2].trim();
    
    // Customer Phone
    const phone = text.match(/(Phone|Mobile|Contact)\s*[:\-]?\s*(\+?\d{10,15})/i);
    if(phone) result.customerPhone = phone[2].trim();
    
    // Items - extract items
    const itemsSection = text.match(/Items\s*[:\-]?\s*(.*?)(?=\n\n|\n[A-Z]|$)/is);
    if(itemsSection) {
      const itemsList = itemsSection[1].split('\n').filter(item => item.trim());
      result.items = itemsList.map(item => item.trim());
    }
    
    // Issue - enhanced patterns
    const issueMatch = text.match(/(missing item[s]?|missing|not delivered|wrong item|cold|late|delayed|short|shortage|overcharged|refund|deduction|adjustment|compensation|damaged|stale|spoiled|burnt|incorrect|incomplete)/i);
    if(issueMatch){
      const im = issueMatch[0];
      const idx = text.indexOf(im);
      const start = Math.max(0, idx - 30);
      const snippet = text.substring(start, idx + im.length + 30).replace(/\s+/g,' ').trim();
      result.issue = snippet;
    } else {
      // fallback: first line or subject-like
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
      if(lines.length) result.issue = lines.slice(0,2).join(' / ');
    }
    
    // A final attempt: if order not found, capture any token like REF/OrderRef numbers
    if(!result.order){
      const ord = text.match(/\b([0-9]{3,10})\b/);
      if(ord) result.order = ord[1];
    }
    
    return result;
  }
  
  function populateForm(fields) {
    branchNameInput.value = fields.branch || '';
    orderDateInput.value = fields.date || '';
    orderNumberInput.value = fields.order || '';
    orderReferenceInput.value = fields.orderReference || '';
    orderSubtotalInput.value = fields.orderSubtotal || '';
    adjustmentAmountInput.value = fields.amount || '';
    adjustmentReasonInput.value = fields.adjustmentReason || '';
    complaintIdInput.value = fields.complaint || '';
    
    // Highlight missing fields
    if (!fields.amount) {
      adjustmentAmountInput.classList.add('missing-field');
    } else {
      adjustmentAmountInput.classList.remove('missing-field');
    }
  }
  
  function getFormData() {
    return {
      branch: branchNameInput.value,
      date: orderDateInput.value,
      order: orderNumberInput.value,
      orderReference: orderReferenceInput.value,
      orderSubtotal: orderSubtotalInput.value,
      amount: adjustmentAmountInput.value,
      adjustmentReason: adjustmentReasonInput.value,
      complaint: complaintIdInput.value
    };
  }
  
  function showNotification(message, type = 'success') {
    notificationText.textContent = message;
    notification.className = 'notification';
    
    // Update icon based on type
    const icon = notification.querySelector('i');
    icon.className = '';
    
    if (type === 'error') {
      notification.classList.add('error');
      icon.className = 'fas fa-exclamation-circle';
    } else if (type === 'warning') {
      notification.classList.add('warning');
      icon.className = 'fas fa-exclamation-triangle';
    } else {
      icon.className = 'fas fa-check-circle';
    }
    
    notification.style.display = 'flex';
    
    setTimeout(() => {
      notification.style.display = 'none';
    }, 3000);
  }
  
  function validateForm() {
    if (!orderNumberInput.value.trim()) {
      showNotification('Order number is required', 'error');
      return false;
    }
    if (!branchNameInput.value.trim()) {
      showNotification('Branch name is required', 'error');
      return false;
    }
    if (!adjustmentAmountInput.value.trim()) {
      showNotification('Compensation amount is required', 'error');
      adjustmentAmountInput.classList.add('missing-field');
      adjustmentAmountInput.focus();
      return false;
    }
    return true;
  }
  
  function addEntry(fields){
    // Get form data
    const formData = getFormData();
    
    // Validate form
    if (!validateForm()) return;
    
    // Create dispute record
    const dispute = {
      platform: fields.platform || '',
      orderId: formData.order || fields.order || '',
      branch: formData.branch || fields.branch || '',
      orderDate: formData.date || fields.date || '',
      orderReference: formData.orderReference || fields.orderReference || '',
      orderSubtotal: formData.orderSubtotal || fields.orderSubtotal || '',
      adjustmentAmount: formData.amount || fields.amount || '',
      adjustmentReason: formData.adjustmentReason || fields.adjustmentReason || '',
      complaintId: formData.complaint || fields.complaint || '',
      issue: fields.issue || '',
      evidence: 'None', // Default value
      status: 'Pending', // Default status
      refunded: '', // Initially empty
      original: fields.original || '',
      customerName: fields.customerName || '',
      customerPhone: fields.customerPhone || '',
      items: fields.items || [],
      id: Date.now() // Unique ID for actions
    };
    
    disputes.push(dispute);
    currentDispute = dispute;
    
    // Save to localStorage
    saveToLocalStorage();
    
    renderDisputeTable();
    updateStats();
    generateReply(fields);
    
    showNotification('Dispute added successfully');
  }
  
  function renderDisputeTable(){
    disputeBody.innerHTML = '';
    
    // Apply filters
    filteredDisputes = disputes.filter(dispute => {
      // Platform filter
      if (filterPlatform.value && dispute.platform !== filterPlatform.value) {
        return false;
      }
      
      // Status filter
      if (filterStatus.value && dispute.status !== filterStatus.value) {
        return false;
      }
      
      // Evidence filter
      if (filterEvidence.value && dispute.evidence !== filterEvidence.value) {
        return false;
      }
      
      // Search filter
      if (searchBox.value.trim()) {
        const searchTerm = searchBox.value.toLowerCase();
        const searchableText = [
          dispute.orderId,
          dispute.branch,
          dispute.issue,
          dispute.adjustmentReason,
          dispute.complaintId
        ].join(' ').toLowerCase();
        
        if (!searchableText.includes(searchTerm)) {
          return false;
        }
      }
      
      return true;
    });
    
    filteredDisputes.forEach((dispute, i) => {
      const tr = document.createElement('tr');
      
      // Determine status badge class
      let statusClass = 'status-pending';
      if (dispute.status === 'Approved') statusClass = 'status-approved';
      else if (dispute.status === 'Rejected') statusClass = 'status-rejected';
      
      // Determine evidence badge class
      let evidenceClass = 'evidence-none';
      if (dispute.evidence === 'Available') evidenceClass = 'evidence-available';
      
      // Check if this is the sample dispute
      if (dispute.orderId === 'FF9ANN275917YZA') {
        tr.classList.add('highlight-row');
      }
      
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${dispute.platform}</td>
        <td>${dispute.orderId}</td>
        <td>${dispute.branch}</td>
        <td>${dispute.orderDate}</td>
        <td>${dispute.orderReference}</td>
        <td>${dispute.orderSubtotal}</td>
        <td>${dispute.adjustmentAmount || '<span style="color:#e53935">Missing</span>'}</td>
        <td style="text-align:left">${dispute.adjustmentReason}</td>
        <td>${dispute.complaintId}</td>
        <td style="text-align:left">${dispute.issue}</td>
        <td><span class="evidence-badge ${evidenceClass}">${dispute.evidence}</span></td>
        <td><span class="status-badge ${statusClass}">${dispute.status}</span></td>
        <td>${dispute.refunded}</td>
        <td>
          <button class="action-btn" onclick="viewDetails(${dispute.id})" title="View Details"><i class="fas fa-eye"></i></button>
          <button class="action-btn" onclick="editDispute(${dispute.id})" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="action-btn" onclick="updateStatus(${dispute.id})" title="Update Status"><i class="fas fa-sync"></i></button>
          <button class="action-btn" onclick="deleteDispute(${dispute.id})" title="Delete"><i class="fas fa-trash"></i></button>
        </td>
      `;
      disputeBody.appendChild(tr);
    });
  }
  
  function updateStats() {
    const total = disputes.length;
    const pending = disputes.filter(d => d.status === 'Pending').length;
    const approved = disputes.filter(d => d.status === 'Approved').length;
    const rejected = disputes.filter(d => d.status === 'Rejected').length;
    
    // Calculate total refunded amount
    let totalRefunded = 0;
    disputes.forEach(d => {
      if (d.refunded) {
        const amount = parseFloat(d.refunded.replace(/[^\d.-]/g, ''));
        if (!isNaN(amount)) {
          totalRefunded += amount;
        }
      }
    });
    
    document.getElementById('totalDisputes').textContent = total;
    document.getElementById('pendingDisputes').textContent = pending;
    document.getElementById('approvedDisputes').textContent = approved;
    document.getElementById('rejectedDisputes').textContent = rejected;
    document.getElementById('totalRefunded').textContent = totalRefunded.toFixed(2);
  }
  
  function generateReply(f){
    // Get selected reasons
    const selectedReasons = [];
    const checkboxes = reasonsGrid.querySelectorAll('input[type="checkbox"]:checked');
    
    checkboxes.forEach(checkbox => {
      selectedReasons.push({
        id: checkbox.value,
        ar: reasonsData[checkbox.value].ar,
        en: reasonsData[checkbox.value].en
      });
    });
    
    // If no reason selected, use default reasons
    if (selectedReasons.length === 0) {
      selectedReasons.push(
        { id: 'noEvidence', ar: reasonsData.noEvidence.ar, en: reasonsData.noEvidence.en },
        { id: 'driverNegligence', ar: reasonsData.driverNegligence.ar, en: reasonsData.driverNegligence.en },
        { id: 'videoEvidence', ar: reasonsData.videoEvidence.ar, en: reasonsData.videoEvidence.en }
      );
    }
    
    // Build reasons text
    const reasonsArText = selectedReasons.map((r, i) => `${i+1}. ${r.ar}`).join('\n');
    const reasonsEnText = selectedReasons.map((r, i) => `${i+1}. ${r.en}`).join('\n');
    
    // Get form data
    const formData = getFormData();
    
    // Arabic template - Updated for rejection with reasons
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${f.issue ? ' ' + f.issue : ' الشكوى'}${formData.order ? ' (رقم الطلب: ' + formData.order + ')' : ''}${formData.branch ? ' - فرع: ' + formData.branch : ''} للأسباب التالية:
${reasonsArText}
نطالب بإلغاء التعويض المطلوب (${formData.amount || ''}) فوراً نظراً لعدم صحة الشكوى.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    // English template - Updated for rejection with reasons
    const en = `Hello,
We reject the compensation request regarding${f.issue ? ' ' + f.issue : ' the complaint'}${formData.order ? ' (Order No: ' + formData.order + ')' : ''}${formData.branch ? ' - Branch: ' + formData.branch : ''} for the following reasons:
${reasonsEnText}
We demand the immediate cancellation of the requested compensation (${formData.amount || ''}) as the complaint is invalid.
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Generate response with evidence
  function generateEvidenceResponse() {
    if (!currentDispute) {
      showNotification('Please add an email first', 'warning');
      return;
    }
    
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${currentDispute.issue ? ' ' + currentDispute.issue : ' الشكوى'}${currentDispute.orderId ? ' (رقم الطلب: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - فرع: ' + currentDispute.branch : ''} للأسباب التالية:
1. نحن نمتلك أدلة قاطعة تثبت أن الطلب تم تجهيزه وتسليمه بشكل صحيح وكامل.
2. تم تصوير عملية التغليف والتسليم بالكامل، والفيديو يوضح عدم وجود أي مشكلة في الطلب.
3. جميع الأصناف المطلوبة تم تجهيزها بدقة وفقًا لطلب العميل.
نطالب بإلغاء التعويض المطلوب (${currentDispute.adjustmentAmount || ''}) فوراً نظراً لوجود أدلة تثبت عدم صحة الشكوى.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    const en = `Hello,
We reject the compensation request regarding${currentDispute.issue ? ' ' + currentDispute.issue : ' the complaint'}${currentDispute.orderId ? ' (Order No: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - Branch: ' + currentDispute.branch : ''} for the following reasons:
1. We have conclusive evidence proving that the order was prepared and delivered correctly and completely.
2. The entire packaging and delivery process was recorded, and the video clearly shows no issues with the order.
3. All requested items were prepared accurately according to the customer's request.
We demand the immediate cancellation of the requested compensation (${currentDispute.adjustmentAmount || ''}) as we have evidence proving the complaint is invalid.
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Generate response based on lack of customer evidence
  function generateNoEvidenceResponse() {
    if (!currentDispute) {
      showNotification('Please add an email first', 'warning');
      return;
    }
    
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${currentDispute.issue ? ' ' + currentDispute.issue : ' الشكوى'}${currentDispute.orderId ? ' (رقم الطلب: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - فرع: ' + currentDispute.branch : ''} للأسباب التالية:
1. العميل لم يقدم أي دليل أو إثبات يدعم ادعاءاته حول وجود مشكلة في الطلب.
2. وفقًا لسياسة المنصة، يجب تقديم أدلة واضحة (صور أو فيديو) لإثبات وجود مشكلة في الطلب.
3. بدون إثباتات، لا يمكن التحقق من صحة الشكوى وبالتالي يتم رفضها.
نطالب بإلغاء التعويض المطلوب (${currentDispute.adjustmentAmount || ''}) فوراً نظراً لعدم وجود أدلة تدعم الشكوى.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    const en = `Hello,
We reject the compensation request regarding${currentDispute.issue ? ' ' + currentDispute.issue : ' the complaint'}${currentDispute.orderId ? ' (Order No: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - Branch: ' + currentDispute.branch : ''} for the following reasons:
1. The customer did not provide any evidence or proof to support their claims about an issue with the order.
2. According to platform policy, clear evidence (photos or videos) must be provided to prove an issue with the order.
3. Without evidence, the validity of the complaint cannot be verified and therefore it is rejected.
We demand the immediate cancellation of the requested compensation (${currentDispute.adjustmentAmount || ''}) as there is no evidence supporting the complaint.
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Generate response for driver negligence
  function generateDriverResponse() {
    if (!currentDispute) {
      showNotification('Please add an email first', 'warning');
      return;
    }
    
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${currentDispute.issue ? ' ' + currentDispute.issue : ' الشكوى'}${currentDispute.orderId ? ' (رقم الطلب: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - فرع: ' + currentDispute.branch : ''} للأسباب التالية:
1. الطلب تم تجهيزه بالكامل وبشكل صحيح في المطعم وفقًا لطلب العميل.
2. تم تسليم الطلب للسائق بشكل كامل وسليم، وأي مشكلة حدثت بعد ذلك تعتبر مسؤولية السائق.
3. إهمال السائق أثناء التوصيل أو سوء التعامل مع الطلب لا يعتبر مسؤولية المطعم.
نطالب بإلغاء التعويض المطلوب (${currentDispute.adjustmentAmount || ''}) فوراً نظراً لأن المشكلة حدثت بسبب إهمال السائق وليس خطأ من المطعم.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    const en = `Hello,
We reject the compensation request regarding${currentDispute.issue ? ' ' + currentDispute.issue : ' the complaint'}${currentDispute.orderId ? ' (Order No: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - Branch: ' + currentDispute.branch : ''} for the following reasons:
1. The order was prepared completely and correctly at the restaurant according to the customer's request.
2. The order was handed over to the driver in full and good condition, any issues that occurred afterward are the driver's responsibility.
3. Driver negligence during delivery or mishandling of the order is not the restaurant's responsibility.
We demand the immediate cancellation of the requested compensation (${currentDispute.adjustmentAmount || ''}) as the issue was caused by driver negligence, not the restaurant's fault.
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Generate custom response
  function generateCustomResponse() {
    if (!currentDispute) {
      showNotification('Please add an email first', 'warning');
      return;
    }
    
    const customReason = prompt('Enter custom rejection reason:');
    if (!customReason) return;
    
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${currentDispute.issue ? ' ' + currentDispute.issue : ' الشكوى'}${currentDispute.orderId ? ' (رقم الطلب: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - فرع: ' + currentDispute.branch : ''} للسبب التالي:
${customReason}
نطالب بإلغاء التعويض المطلوب (${currentDispute.adjustmentAmount || ''}) فوراً.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    const en = `Hello,
We reject the compensation request regarding${currentDispute.issue ? ' ' + currentDispute.issue : ' the complaint'}${currentDispute.orderId ? ' (Order No: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - Branch: ' + currentDispute.branch : ''} for the following reason:
${customReason}
We demand the immediate cancellation of the requested compensation (${currentDispute.adjustmentAmount || ''}).
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Local Storage Functions
  function saveToLocalStorage() {
    try {
      localStorage.setItem('crispyDisputes', JSON.stringify(disputes));
      showNotification('Data saved locally');
    } catch (e) {
      showNotification('Failed to save data: ' + e.message, 'error');
    }
  }
  
  function loadFromLocalStorage() {
    try {
      const saved = localStorage.getItem('crispyDisputes');
      if (saved) {
        disputes = JSON.parse(saved);
        renderDisputeTable();
        updateStats();
        showNotification('Data loaded from local storage');
      } else {
        showNotification('No saved data found', 'warning');
      }
    } catch (e) {
      showNotification('Failed to load data: ' + e.message, 'error');
    }
  }
  
  // Action functions for dispute table
  window.viewDetails = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (dispute) {
      let details = `Dispute Details:\n\n`;
      details += `Order Number: ${dispute.orderId}\n`;
      details += `Date: ${dispute.orderDate}\n`;
      details += `Branch: ${dispute.branch}\n`;
      details += `Platform: ${dispute.platform}\n`;
      details += `Issue: ${dispute.issue}\n`;
      details += `Compensation: ${dispute.adjustmentAmount || 'Missing'}\n`;
      details += `Reference: ${dispute.orderReference}\n`;
      details += `Subtotal: ${dispute.orderSubtotal}\n`;
      details += `Compensation Reason: ${dispute.adjustmentReason}\n`;
      details += `Complaint ID: ${dispute.complaintId}\n`;
      details += `Evidence Status: ${dispute.evidence}\n`;
      details += `Status: ${dispute.status}\n`;
      details += `Refunded Amount: ${dispute.refunded}\n`;
      
      if (dispute.customerName) details += `Customer Name: ${dispute.customerName}\n`;
      if (dispute.customerPhone) details += `Customer Phone: ${dispute.customerPhone}\n`;
      if (dispute.items.length > 0) details += `Items: ${dispute.items.join(', ')}\n`;
      
      alert(details);
    }
  };
  
  window.editDispute = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (dispute) {
      // Populate form with dispute data
      populateForm(dispute);
      
      // Set as current dispute
      currentDispute = dispute;
      
      // Generate reply for this dispute
      generateReply(dispute);
      
      showNotification('Dispute data loaded in the form above. You can modify the data and then create a new reply.');
    }
  };
  
  window.updateStatus = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (dispute) {
      const newStatus = prompt('Update dispute status (Pending/Approved/Rejected):', dispute.status);
      if (newStatus && (newStatus === 'Pending' || newStatus === 'Approved' || newStatus === 'Rejected')) {
        dispute.status = newStatus;
        saveToLocalStorage();
        renderDisputeTable();
        updateStats();
      }
      
      const newEvidence = prompt('Update evidence status (None/Available):', dispute.evidence);
      if (newEvidence && (newEvidence === 'None' || newEvidence === 'Available')) {
        dispute.evidence = newEvidence;
        saveToLocalStorage();
        renderDisputeTable();
      }
      
      const refunded = prompt('Enter refunded amount (if any):', dispute.refunded);
      if (refunded !== null) {
        dispute.refunded = refunded;
        saveToLocalStorage();
        renderDisputeTable();
        updateStats();
      }
    }
  };
  
  window.deleteDispute = function(id) {
    if (confirm('Are you sure you want to delete this dispute?')) {
      disputes = disputes.filter(d => d.id !== id);
      saveToLocalStorage();
      renderDisputeTable();
      updateStats();
      
      if (currentDispute && currentDispute.id === id) {
        currentDispute = null;
      }
      
      showNotification('Dispute deleted successfully');
    }
  };
  
  parseBtn.addEventListener('click', ()=>{
    const txt = emailText.value.trim();
    if(!txt){ 
      showNotification('Please paste the email text first.', 'error');
      return; 
    }
    const parsed = extractFields(txt);
    // If user selected platform manually, override
    if(platformSelect.value) parsed.platform = platformSelect.value;
    
    // Populate form with extracted data
    populateForm(parsed);
    
    // Check if adjustment amount is missing
    if (!parsed.amount) {
      showNotification('Compensation amount is missing, please enter it manually', 'warning');
      adjustmentAmountInput.focus();
    }
    
    addEntry(parsed);
    // clear input for next
    emailText.value = '';
  });
  
  document.getElementById('clearBtn').addEventListener('click', ()=>{ 
    emailText.value = ''; 
    showNotification('Field cleared');
  });
  
  // CSV download
  document.getElementById('downloadCsv').addEventListener('click', ()=>{
    if(disputes.length===0){ 
      showNotification('No data to download.', 'warning');
      return; 
    }
    
    // Helper function to format CSV fields
    function formatCsvField(field) {
      if (field === null || field === undefined) return '';
      field = field.toString();
      if (field.includes(',') || field.includes('\n') || field.includes('"')) {
        return '"' + field.replace(/"/g, '""') + '"';
      }
      return field;
    }
    
    const headers = ['#', 'Platform', 'Order ID', 'Branch', 'Order Date', 'Order Reference', 'Order Subtotal', 'Adjustment Amount', 'Adjustment Reason', 'Complaint ID', 'Issue', 'Evidence', 'Status', 'Refunded', 'Customer Name', 'Customer Phone', 'Items', 'Original Email'];
    const formattedHeaders = headers.map(h => formatCsvField(h));
    
    const rows = disputes.map((dispute, i) => [
      formatCsvField(i+1),
      formatCsvField(dispute.platform),
      formatCsvField(dispute.orderId),
      formatCsvField(dispute.branch),
      formatCsvField(dispute.orderDate),
      formatCsvField(dispute.orderReference),
      formatCsvField(dispute.orderSubtotal),
      formatCsvField(dispute.adjustmentAmount),
      formatCsvField(dispute.adjustmentReason),
      formatCsvField(dispute.complaintId),
      formatCsvField(dispute.issue),
      formatCsvField(dispute.evidence),
      formatCsvField(dispute.status),
      formatCsvField(dispute.refunded),
      formatCsvField(dispute.customerName),
      formatCsvField(dispute.customerPhone),
      formatCsvField(dispute.items.join('; ')),
      formatCsvField((dispute.original || '').replace(/\r?\n/g, ' '))
    ]);
    
    const csv = [formattedHeaders.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'disputes_sheet.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    
    showNotification('CSV file downloaded successfully');
  });
  
  // Local Storage buttons
  document.getElementById('saveToLocal').addEventListener('click', saveToLocalStorage);
  document.getElementById('loadFromLocal').addEventListener('click', loadFromLocalStorage);
  
  // copy buttons
  document.getElementById('copyAr').addEventListener('click', ()=>{
    navigator.clipboard.writeText(replyAr.value).then(()=>{
      const el = document.getElementById('copiedAr');
      el.style.display = 'inline';
      setTimeout(()=>el.style.display='none',2000);
      showNotification('Arabic reply copied');
    });
  });
  
  document.getElementById('copyEn').addEventListener('click', ()=>{
    navigator.clipboard.writeText(replyEn.value).then(()=>{
      const el = document.getElementById('copiedEn');
      el.style.display = 'inline';
      setTimeout(()=>el.style.display='none',2000);
      showNotification('English reply copied');
    });
  });
  
  // Allow double-click on table row to edit reply using that entry
  disputeBody.addEventListener('dblclick', (ev)=>{
    let tr = ev.target.closest('tr');
    if(!tr) return;
    const idx = parseInt(tr.children[0].textContent,10)-1;
    if(disputes[idx]) {
      currentDispute = disputes[idx];
      
      // Populate form with entry data
      populateForm(disputes[idx]);
      
      generateReply(disputes[idx]);
      showNotification('Data from this record loaded in reply drafts above. Edit the text then copy to send.');
    }
  });
  
  // Update reply when reasons are selected
  reasonsGrid.addEventListener('change', () => {
    if (currentDispute) {
      generateReply(currentDispute);
    }
  });
  
  // Response buttons event listeners
  evidenceBtn.addEventListener('click', generateEvidenceResponse);
  noEvidenceBtn.addEventListener('click', generateNoEvidenceResponse);
  driverBtn.addEventListener('click', generateDriverResponse);
  customReplyBtn.addEventListener('click', generateCustomResponse);
  
  // Filter event listeners
  searchBox.addEventListener('input', renderDisputeTable);
  filterPlatform.addEventListener('change', renderDisputeTable);
  filterStatus.addEventListener('change', renderDisputeTable);
  filterEvidence.addEventListener('change', renderDisputeTable);
  
  // Form input event listeners to update current dispute
  branchNameInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.branch = branchNameInput.value;
    }
  });
  
  orderDateInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.orderDate = orderDateInput.value;
    }
  });
  
  orderNumberInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.orderId = orderNumberInput.value;
    }
  });
  
  orderReferenceInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.orderReference = orderReferenceInput.value;
    }
  });
  
  orderSubtotalInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.orderSubtotal = orderSubtotalInput.value;
    }
  });
  
  adjustmentAmountInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.adjustmentAmount = adjustmentAmountInput.value;
    }
    // Remove highlight when user enters a value
    if (adjustmentAmountInput.value.trim()) {
      adjustmentAmountInput.classList.remove('missing-field');
    }
  });
  
  adjustmentReasonInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.adjustmentReason = adjustmentReasonInput.value;
    }
  });
  
  complaintIdInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.complaintId = complaintIdInput.value;
    }
  });
  
  // Initialize with sample data
  function initializeSampleData() {
    // Add sample dispute to the list
    disputes.push(sampleDispute);
    currentDispute = sampleDispute;
    
    // Populate form with sample data
    populateForm(sampleDispute);
    
    // Render the table
    renderDisputeTable();
    updateStats();
    
    // Generate a default reply
    generateReply(sampleDispute);
  }
  
  // Initialize the page with sample data
  initializeSampleData();
  
  // Auto-parse the pre-filled email on page load
  window.addEventListener('load', () => {
    if (emailText.value.trim()) {
      const parsed = extractFields(emailText.value);
      populateForm(parsed);
      
      // Check if adjustment amount is missing
      if (!parsed.amount) {
        showNotification('Compensation amount is missing, please enter it manually', 'warning');
        adjustmentAmountInput.focus();
      }
    }
  });
})();
</script>
</body>
</html>
