<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dispute Management System — Crispy Chicken</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .small {font-size:13px;color:#6b7280}
    .status-badge{padding:4px 8px;border-radius:999px;font-weight:600;font-size:12px}
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
  <div class="container mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Dispute Management — Crispy Chicken</h1>
      <div class="text-right small">
        <div>Call Center Manager: Ahmed Kenawy</div>
        <div>Delivery Hotline: 600-527-488</div>
      </div>
    </header>
    <!-- Controls -->
    <div class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="md:col-span-2 bg-white p-4 rounded shadow">
        <label class="block font-semibold mb-2">Paste full platform email / dispute text</label>
        <textarea id="emailText" class="w-full border rounded p-3 h-40" placeholder="Paste Noon / Careem / Talabat email here..."></textarea>
        <div class="mt-3 flex gap-2">
          <button id="parseBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Extract & Add</button>
          <button id="previewBtn" class="bg-gray-200 px-4 py-2 rounded">Preview Extract</button>
          <button id="clearBtn" class="bg-gray-300 px-4 py-2 rounded">Clear</button>
        </div>
        <p class="small mt-2">Supports detection of Order IDs (FF.../numeric), Branch, Date, AED amounts, Reference and reason keywords. Edit fields if needed before saving.</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <label class="block font-semibold mb-2">Quick Filters / Actions</label>
        <div class="flex flex-col gap-2">
          <select id="filterBranch" class="border rounded p-2">
            <option value="">-- All Branches --</option>
          </select>
          <select id="filterStatus" class="border rounded p-2">
            <option value="">-- All Statuses --</option>
            <option>Pending</option>
            <option>Rejected</option>
            <option>Approved</option>
            <option>Resolved</option>
          </select>
          <div class="flex gap-2 mt-2">
            <button id="exportBtn" class="flex-1 bg-indigo-600 text-white px-3 py-2 rounded">Export CSV</button>
            <button id="downloadEmlAll" class="flex-1 bg-emerald-600 text-white px-3 py-2 rounded">Download .eml (All)</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Form + Reply -->
    <div class="grid lg:grid-cols-2 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-2">Dispute Details</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block small mb-1">Order ID</label>
            <input id="orderId" class="w-full border rounded p-2" placeholder="Order ID (e.g. FF91NN...)">
          </div>
          <div>
            <label class="block small mb-1">Platform</label>
            <select id="platform" class="w-full border rounded p-2">
              <option>Noon</option>
              <option>Careem</option>
              <option>Talabat</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="block small mb-1">Branch</label>
            <input id="branchInput" class="w-full border rounded p-2" placeholder="Crispy Chicken - Al Barsha">
          </div>
          <div>
            <label class="block small mb-1">Order Date</label>
            <input id="orderDate" class="w-full border rounded p-2" placeholder="2025-09-10 21:13:37">
          </div>
          <div>
            <label class="block small mb-1">Order Subtotal (AED)</label>
            <input id="orderSubtotal" class="w-full border rounded p-2" placeholder="30.00">
          </div>
          <div>
            <label class="block small mb-1">Adjustment / Compensation (AED)</label>
            <input id="adjustmentAmount" class="w-full border rounded p-2" placeholder="-12.00">
          </div>
          <div class="md:col-span-2">
            <label class="block small mb-1">Adjustment Reason</label>
            <input id="adjustmentReason" class="w-full border rounded p-2" placeholder="DT-auto-refund Missing item - Outlet">
          </div>
          <div class="md:col-span-2">
            <label class="block small mb-1">Issue / Short Note</label>
            <input id="issueNote" class="w-full border rounded p-2" placeholder="Missing item / Wrong order / Spilled">
          </div>
          <div class="md:col-span-2 flex gap-2">
            <button id="saveBtn" class="bg-green-600 text-white px-4 py-2 rounded flex-1">Save Dispute</button>
            <button id="updateBtn" class="bg-yellow-500 text-white px-4 py-2 rounded flex-1">Update Selected</button>
            <button id="clearFormBtn" class="bg-gray-200 px-4 py-2 rounded flex-1">Clear</button>
          </div>
        </div>
        <div class="mt-3">
          <label class="block small mb-1">Upload Evidence (optional)</label>
          <input id="evidenceFile" type="file" accept="image/*,video/*" class="block">
          <div class="small mt-1 text-gray-600">Uploaded evidence is stored in browser memory for this session only (no server).</div>
        </div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-2">Reply Generator</h2>
        <div class="mb-2 small">Choose quick response type</div>
        <div class="flex gap-2 mb-3">
          <button id="btnNoEvidence" class="flex-1 bg-red-500 text-white px-3 py-2 rounded">No Evidence</button>
          <button id="btnEvidence" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded">Has Evidence</button>
          <button id="btnDriver" class="flex-1 bg-orange-500 text-white px-3 py-2 rounded">Driver Negligence</button>
          <button id="btnCancellation" class="flex-1 bg-purple-600 text-white px-3 py-2 rounded">Cancellation</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block small mb-1">Arabic Reply</label>
            <textarea id="replyAr" class="w-full border rounded p-3 h-40" placeholder="Generated Arabic reply"></textarea>
            <div class="mt-1">
              <button id="copyAr" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Copy Arabic</button>
            </div>
          </div>
          <div>
            <label class="block small mb-1">English Reply</label>
            <textarea id="replyEn" class="w-full border rounded p-3 h-40" placeholder="Generated English reply"></textarea>
            <div class="mt-1">
              <button id="copyEn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Copy English</button>
            </div>
          </div>
        </div>
        <div class="flex gap-2 mt-3">
          <button id="downloadEml" class="bg-emerald-600 text-white px-4 py-2 rounded">Download .eml</button>
          <button id="markResolvedBtn" class="bg-green-600 text-white px-4 py-2 rounded">Mark as Resolved</button>
        </div>
      </div>
    </div>
    <!-- Records Table -->
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Dispute Records</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="recordsTable">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">#</th>
              <th class="border px-2 py-1">Platform</th>
              <th class="border px-2 py-1">Order ID</th>
              <th class="border px-2 py-1">Branch</th>
              <th class="border px-2 py-1">Date</th>
              <th class="border px-2 py-1">Adj. Amount</th>
              <th class="border px-2 py-1">Reason</th>
              <th class="border px-2 py-1">Evidence</th>
              <th class="border px-2 py-1">Status</th>
              <th class="border px-2 py-1">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <footer class="mt-4 text-center small text-gray-600">Local session storage only • Designed for Ahmed Kenawy / Crispy Chicken</footer>
  </div>

<script>
// Helper utilities
function uid(){return Date.now()+Math.floor(Math.random()*1000)}
function fmt(v){return (v||'').toString().replace(/\n/g,' ')}

// Elements
const emailText = document.getElementById('emailText');
const parseBtn = document.getElementById('parseBtn');
const previewBtn = document.getElementById('previewBtn');
const clearBtn = document.getElementById('clearBtn');
const orderIdEl = document.getElementById('orderId');
const platformEl = document.getElementById('platform');
const branchEl = document.getElementById('branchInput');
const dateEl = document.getElementById('orderDate');
const subtotalEl = document.getElementById('orderSubtotal');
const adjEl = document.getElementById('adjustmentAmount');
const adjReasonEl = document.getElementById('adjustmentReason');
const issueEl = document.getElementById('issueNote');
const evidenceFile = document.getElementById('evidenceFile');
const saveBtn = document.getElementById('saveBtn');
const updateBtn = document.getElementById('updateBtn');
const clearFormBtn = document.getElementById('clearFormBtn');
const btnNoEvidence = document.getElementById('btnNoEvidence');
const btnEvidence = document.getElementById('btnEvidence');
const btnDriver = document.getElementById('btnDriver');
const btnCancellation = document.getElementById('btnCancellation');
const replyAr = document.getElementById('replyAr');
const replyEn = document.getElementById('replyEn');
const copyAr = document.getElementById('copyAr');
const copyEn = document.getElementById('copyEn');
const downloadEml = document.getElementById('downloadEml');
const markResolvedBtn = document.getElementById('markResolvedBtn');
const downloadEmlAll = document.getElementById('downloadEmlAll');
const recordsTableBody = document.querySelector('#recordsTable tbody');
const filterBranch = document.getElementById('filterBranch');
const filterStatus = document.getElementById('filterStatus');
const exportBtn = document.getElementById('exportBtn');

// In-memory store
let records = [];
let selectedId = null;

// Parsing function (improved)
function extractFields(text){
  const out = {orderId:'', branch:'', date:'', subtotal:'', adjustment:'', adjustmentReason:'', issue:''};
  if(!text) return out;
  const lower = text.toLowerCase();
  
  // Order like FF97NN... or numeric
  const ord = text.match(/\b([A-Z]{2}\d{3,}[A-Z0-9\-]*)\b/i) || text.match(/order\s*#?\s*(\d{3,10})/i);
  if(ord) out.orderId = ord[1];
  
  // Branch / Outlet
  const b = text.match(/branch\s*name\s*[:\-]?\s*([A-Za-z0-9 \-\u0600-\u06FF]{3,60})/i) || 
             text.match(/outlet\s*[:\-]?\s*([A-Za-z0-9 \-\u0600-\u06FF]{3,60})/i) || 
             text.match(/crispy chicken\s*\-\s*([A-Za-z0-9 \-]{2,40})/i);
  if(b) out.branch = b[1].trim();
  
  // Date ISO or dd/mm/yyyy
  const d = text.match(/(\d{4}-\d{2}-\d{2}(?: \d{2}:\d{2}:\d{2})?)/) || text.match(/(\d{2}\/\d{2}\/\d{4})/);
  if(d) out.date = d[1];
  
  // AED amounts
  const amt = text.match(/([AED\s]*)(-?\d{1,3}(?:,\d{3})?(?:\.\d{1,2})?)\s*(AED|aed|د\.إ|درهم)?/);
  if(amt) out.subtotal = amt[2];
  
  // adjustment reason
  const adj = text.match(/adjustment reason\s*[:\-]?\s*([A-Za-z0-9 \-\u0600-\u06FF\(\)\/]{3,80})/i) || 
             text.match(/reason\s*[:\-]?\s*([A-Za-z0-9 \-\u0600-\u06FF]{3,80})/i);
  if(adj) out.adjustmentReason = adj[1].trim();
  
  // issue keywords
  const issueM = text.match(/(missing item[s]?|missing|not delivered|wrong order|spilled|damaged|shortage|overcharged|refund|deduction|adjustment)/i);
  if(issueM) out.issue = issueM[0];
  
  return out;
}

// Render helpers
function refreshFilters(){
  const branches = Array.from(new Set(records.map(r=>r.branch).filter(Boolean)));
  filterBranch.innerHTML = '<option value="">-- All Branches --</option>' + branches.map(b=>`<option>${b}</option>`).join('');
}

function renderTable(){
  recordsTableBody.innerHTML = '';
  const filtered = records.filter(r=>{
    if(filterBranch.value && r.branch !== filterBranch.value) return false;
    if(filterStatus.value && r.status !== filterStatus.value) return false;
    return true;
  });
  
  filtered.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border px-2 py-1">${i+1}</td>
      <td class="border px-2 py-1">${r.platform||''}</td>
      <td class="border px-2 py-1">${r.orderId||''}</td>
      <td class="border px-2 py-1">${r.branch||''}</td>
      <td class="border px-2 py-1">${r.orderDate||''}</td>
      <td class="border px-2 py-1">${r.adjustmentAmount||''}</td>
      <td class="border px-2 py-1">${r.adjustmentReason||''}</td>
      <td class="border px-2 py-1">${r.evidence?'<span class="status-badge bg-green-100 text-green-800">Yes</span>':'<span class="status-badge bg-red-100 text-red-800">No</span>'}</td>
      <td class="border px-2 py-1">
        ${r.status === 'Resolved' ? '<span class="status-badge bg-green-100 text-green-800">Resolved</span>' : 
          r.status === 'Rejected' ? '<span class="status-badge bg-red-100 text-red-800">Rejected</span>' :
          r.status === 'Approved' ? '<span class="status-badge bg-blue-100 text-blue-800">Approved</span>' :
          '<span class="status-badge bg-yellow-100 text-yellow-800">Pending</span>'}
      </td>
      <td class="border px-2 py-1 text-center">
        <button class="px-2 py-1 rounded bg-yellow-300 mr-1" onclick="editRecord('${r.id}')">Edit</button>
        <button class="px-2 py-1 rounded bg-gray-200 mr-1" onclick="viewRecord('${r.id}')">View</button>
        <button class="px-2 py-1 rounded bg-red-500 text-white" onclick="deleteRecord('${r.id}')">Delete</button>
      </td>`;
    recordsTableBody.appendChild(tr);
  });
}

// CRUD
function saveRecord(){
  const rec = {
    id: uid(),
    platform: platformEl.value,
    orderId: orderIdEl.value.trim(),
    branch: branchEl.value.trim(),
    orderDate: dateEl.value.trim(),
    orderSubtotal: subtotalEl.value.trim(),
    adjustmentAmount: adjEl.value.trim(),
    adjustmentReason: adjReasonEl.value.trim(),
    issue: issueEl.value.trim(),
    evidence: null,
    status: 'Pending',
    createdAt: new Date().toISOString()
  };
  
  if(evidenceFile.files && evidenceFile.files[0]){
    const f = evidenceFile.files[0];
    rec.evidence = {name:f.name, size:f.size, type:f.type};
  }
  
  records.unshift(rec);
  selectedId = rec.id;
  refreshFilters(); 
  renderTable(); 
  clearForm(); 
  generateQuickReply(rec, 'noEvidence');
}

function updateRecord(){
  if(!selectedId){ alert('Select a record to update (click Edit).'); return; }
  const idx = records.findIndex(r=>r.id===selectedId);
  if(idx===-1) return;
  
  const r = records[idx];
  r.platform = platformEl.value;
  r.orderId = orderIdEl.value.trim();
  r.branch = branchEl.value.trim();
  r.orderDate = dateEl.value.trim();
  r.orderSubtotal = subtotalEl.value.trim();
  r.adjustmentAmount = adjEl.value.trim();
  r.adjustmentReason = adjReasonEl.value.trim();
  r.issue = issueEl.value.trim();
  
  if(evidenceFile.files && evidenceFile.files[0]){
    const f = evidenceFile.files[0];
    r.evidence = {name:f.name,size:f.size,type:f.type};
  }
  
  records[idx]=r;
  refreshFilters(); 
  renderTable(); 
  generateQuickReply(r,'noEvidence');
}

window.editRecord = function(id){
  const r = records.find(x=>x.id===id);
  if(!r) return;
  
  selectedId = r.id;
  platformEl.value = r.platform||'Noon';
  orderIdEl.value = r.orderId||'';
  branchEl.value = r.branch||'';
  dateEl.value = r.orderDate||'';
  subtotalEl.value = r.orderSubtotal||'';
  adjEl.value = r.adjustmentAmount||'';
  adjReasonEl.value = r.adjustmentReason||'';
  issueEl.value = r.issue||'';
  
  alert('Record loaded into form. Make edits and press Update Selected.');
}

window.viewRecord = function(id){
  const r = records.find(x=>x.id===id);
  if(!r) return;
  
  const txt = `Order ID: ${r.orderId}\nPlatform: ${r.platform}\nBranch: ${r.branch}\nDate: ${r.orderDate}\nAdjustment: ${r.adjustmentAmount}\nReason: ${r.adjustmentReason}\nStatus: ${r.status}\nEvidence: ${r.evidence? r.evidence.name : 'No'}`;
  alert(txt);
}

window.deleteRecord = function(id){
  if(!confirm('Delete this record?')) return;
  records = records.filter(r=>r.id!==id);
  renderTable(); 
  refreshFilters();
}

// Reply generator
function generateQuickReply(rec, type){
  if(!rec) return;
  const platform = rec.platform || '';
  const orderId = rec.orderId || '';
  const branch = rec.branch || '';
  const adjustmentAmount = rec.adjustmentAmount || '';
  const adjustmentReason = rec.adjustmentReason || rec.issue || '';

  let ar = '';
  let en = '';

  if (type === 'evidence') {
    en = `Hello,\n\nRegarding Order ${orderId} - ${branch}, we note an adjustment of AED ${adjustmentAmount} for "${adjustmentReason}". We have conclusive evidence (packaging and delivery video) proving the order was prepared and handed over correctly. Please reverse the adjustment immediately as the claim is not supported.\n\nBest regards,\nCrispy Chicken Customer Service`;
    ar = `السادة المحترمين في ${platform}،\nبخصوص الطلب رقم ${orderId} - فرع ${branch}، نلاحظ وجود خصم بقيمة ${adjustmentAmount} درهم إماراتي لسبب "${adjustmentReason}".\nلدينا أدلة قاطعة (فيديو التغليف والتسليم) تثبت أن الطلب تم تجهيزه وتسليمه بشكل صحيح. نرجو إلغاء الخصم فورًا لأن الادعاء غير مدعوم.\nمع تحيات،\nفريق خدمة العملاء - Crispy Chicken\nهاتف التوصيل: 600-527-488`;
  } else if (type === 'driver') {
    en = `Hello,\n\nRegarding Order ${orderId} - ${branch}, we note an adjustment of AED ${adjustmentAmount} for "${adjustmentReason}". The order was prepared correctly and handed to the driver in full. Any damage, spillage or missing items that occurred after handover are the driver's responsibility. Please attribute this deduction to delivery handling rather than the restaurant.\n\nBest regards,\nCrispy Chicken Customer Service`;
    ar = `السادة المحترمين في ${platform}،\nبخصوص الطلب رقم ${orderId} - فرع ${branch}، نلاحظ وجود خصم بقيمة ${adjustmentAmount} درهم إماراتي لسبب "${adjustmentReason}".\nتم تجهيز الطلب بشكل صحيح وتسليمه للسائق بالكامل. أي ضرر أو تسرب أو فقدان حدث بعد التسليم هو مسؤولية السائق.\nنرجو إرجاع هذا الخصم إلى التعامل مع التوصيل بدلاً من المطعم.\nمع تحيات،\nفريق خدمة العملاء - Crispy Chicken\nهاتف التوصيل: 600-527-488`;
  } else if (type === 'cancellation') {
    en = `Dear ${platform} Team,\n\nWe would like to inform you that the dispute regarding Order ${orderId} - ${branch} has been resolved. We kindly request to cancel the applied deduction of ${adjustmentAmount} AED, as the dispute has been resolved in agreement with the customer.\n\nThank you for your cooperation,\nCrispy Chicken Customer Service\nDelivery Hotline: 600-527-488`;
    ar = `السادة المحترمين في ${platform}،\nنود إعلامكم بأنه تم حل النزاع بخصوص الطلب رقم ${orderId} - فرع ${branch}.\nنطلب منكم إلغاء الخصم المطبق بقيمة ${adjustmentAmount} درهم إماراتي، حيث أن النزاع قد تم حله بالاتفاق مع العميل.\nنشكركم على تعاونكم،\nفريق خدمة العملاء - Crispy Chicken\nهاتف التوصيل: 600-527-488`;
  } else {
    en = `Hello,\n\nRegarding Order ${orderId} - ${branch}, we note an adjustment of AED ${adjustmentAmount} for "${adjustmentReason}". The customer has not provided sufficient photographic or video evidence to support the claim. According to platform policy, clear evidence is required to validate such deductions. Please reverse the adjustment until valid proof is supplied.\n\nBest regards,\nCrispy Chicken Customer Service`;
    ar = `السادة المحترمين في ${platform}،\nبخصوص الطلب رقم ${orderId} - فرع ${branch}، نلاحظ وجود خصم بقيمة ${adjustmentAmount} درهم إماراتي لسبب "${adjustmentReason}".\nالعميل لم يقدم أدلة كافية (صور أو فيديو) لدعم ادعاءاته. وفقًا لسياسة المنصة، يتطلب إثباتًا واضحًا للتحقق من مثل هذه الخصومات.\nنرجو إلغاء الخصم حتى يتم تقديم إثبات صالح.\nمع تحيات،\nفريق خدمة العملاء - Crispy Chicken\nهاتف التوصيل: 600-527-488`;
  }

  replyAr.value = ar;
  replyEn.value = en;
}

// Download .eml (simple representation)
function emlFor(rec, body){
  const subject = `Dispute: Order ${rec.orderId} — ${rec.adjustmentAmount}`;
  const from = 'KENAWE@CRISPYCHICKEN.REST';
  const to = 'partner@example.com';
  const e = `From: ${from}\nTo: ${to}\nSubject: ${subject}\nContent-Type: text/plain; charset=utf-8\n\n${body}`;
  return e;
}

function downloadEmlFor(rec){
  const body = replyEn.value || '';
  const content = emlFor(rec, body);
  const blob = new Blob([content], {type:'message/rfc822'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `dispute_${rec.orderId || rec.id}.eml`;
  a.click();
}

// Batch .eml
function downloadEmlAllFunc(){
  if(records.length===0){ alert('No records'); return; }
  records.forEach(rec=>{
    const b = emlFor(rec, `Please review dispute for order ${rec.orderId}`);
    const blob = new Blob([b], {type:'message/rfc822'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dispute_${rec.orderId || rec.id}.eml`;
    a.click();
  });
}

// Export CSV
function exportCsv(){
  if(records.length===0){ alert('No records to export'); return; }
  
  const headers = ['Order ID','Platform','Branch','Date','Subtotal','Adj Amount','Reason','Evidence','Status','CreatedAt'];
  const rows = records.map(r=>[
    r.orderId||'', 
    r.platform||'', 
    r.branch||'', 
    r.orderDate||'', 
    r.orderSubtotal||'', 
    r.adjustmentAmount||'', 
    (r.adjustmentReason||r.issue||''), 
    (r.evidence? r.evidence.name:''), 
    r.status||'', 
    r.createdAt||''
  ]);
  
  const csv = [headers.join(','), ...rows.map(row=>row.map(cell=>`"${(cell||'').toString().replace(/"/g,'""')}"`).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'crisp_disputes.csv';
  a.click();
}

// Mark as resolved
function markAsResolved() {
  if (!selectedId) {
    alert('Please select a dispute record first');
    return;
  }
  
  const record = records.find(r => r.id === selectedId);
  if (!record) return;
  
  // Update status to Resolved
  record.status = 'Resolved';
  renderTable();
  
  // Generate cancellation template
  generateQuickReply(record, 'cancellation');
  
  alert(`Dispute for Order ${record.orderId} has been marked as Resolved. Cancellation template generated.`);
}

// UI events
parseBtn.addEventListener('click', ()=>{
  const txt = emailText.value.trim();
  if(!txt){ alert('Paste email text first'); return; }
  
  const f = extractFields(txt);
  orderIdEl.value = f.orderId || '';
  branchEl.value = f.branch || '';
  dateEl.value = f.date || '';
  subtotalEl.value = f.subtotal || '';
  adjEl.value = f.adjustment || '';
  adjReasonEl.value = f.adjustmentReason || '';
  issueEl.value = f.issue || '';
  
  saveRecord();
  emailText.value = '';
});

previewBtn.addEventListener('click', ()=>{
  const txt = emailText.value.trim();
  if(!txt){ alert('Paste email text first'); return; }
  const f = extractFields(txt);
  alert(JSON.stringify(f,null,2));
});

clearBtn.addEventListener('click', ()=> emailText.value='');
saveBtn.addEventListener('click', ()=> saveRecord());
updateBtn.addEventListener('click', ()=> updateRecord());
clearFormBtn.addEventListener('click', ()=> clearForm());

btnNoEvidence.addEventListener('click', ()=>{
  const rec = records.find(r=>r.id===selectedId) || records[0];
  if(!rec){ alert('Select or save a record first'); return; }
  generateQuickReply(rec,'noEvidence');
});

btnEvidence.addEventListener('click', ()=>{
  const rec = records.find(r=>r.id===selectedId) || records[0];
  if(!rec){ alert('Select or save a record first'); return; }
  generateQuickReply(rec,'evidence');
});

btnDriver.addEventListener('click', ()=>{
  const rec = records.find(r=>r.id===selectedId) || records[0];
  if(!rec){ alert('Select or save a record first'); return; }
  generateQuickReply(rec,'driver');
});

btnCancellation.addEventListener('click', ()=>{
  const rec = records.find(r=>r.id===selectedId) || records[0];
  if(!rec){ alert('Select or save a record first'); return; }
  generateQuickReply(rec,'cancellation');
});

copyAr.addEventListener('click', ()=>{
  replyAr.select();
  document.execCommand('copy');
  alert('Arabic reply copied');
});

copyEn.addEventListener('click', ()=>{
  replyEn.select();
  document.execCommand('copy');
  alert('English reply copied');
});

downloadEml.addEventListener('click', ()=>{
  const rec = records.find(r=>r.id===selectedId) || records[0];
  if(!rec){ alert('Select or save a record first'); return; }
  downloadEmlFor(rec);
});

markResolvedBtn.addEventListener('click', markAsResolved);

downloadEmlAll.addEventListener('click', ()=> downloadEmlAllFunc());
exportBtn.addEventListener('click', ()=> exportCsv());
filterBranch.addEventListener('change', ()=> renderTable());
filterStatus.addEventListener('change', ()=> renderTable());

function clearForm(){
  selectedId = null;
  platformEl.value = 'Noon';
  orderIdEl.value = '';
  branchEl.value = '';
  dateEl.value = '';
  subtotalEl.value = '';
  adjEl.value = '';
  adjReasonEl.value = '';
  issueEl.value = '';
  evidenceFile.value = '';
}

// Init with a sample record for convenience
(function initSample(){
  const s = {
    id: uid(), 
    platform: 'Noon', 
    orderId: 'FF9ANN275917YZA', 
    branch: 'Crispy Chicken - Al Barsha', 
    orderDate:'2025-09-10 21:13:37', 
    orderSubtotal:'30.00', 
    adjustmentAmount:'-12.00', 
    adjustmentReason:'DT-auto-refund Missing item - Outlet', 
    issue:'Missing item', 
    evidence:null, 
    status:'Pending', 
    createdAt:new Date().toISOString()
  };
  records.push(s);
  refreshFilters(); 
  renderTable();
})();
</script>
</body>
</html>
