<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dispute Email Management Screen - Crispy Chicken</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;direction:ltr;padding:18px;background:#f7f7f7}
  h1{margin-top:0}
  textarea{width:100%;height:160px;padding:10px;font-size:14px}
  input, button, select {font-size:14px;padding:8px;margin:6px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1;min-width:200px}
  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  th{background:#f0f0f0}
  .controls{margin-top:8px}
  .small{font-size:13px;color:#555}
  .btn{cursor:pointer}
  .copy-ok{color:green;font-weight:600}
  .reasons-section {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 15px;
  }
  .reasons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  .reason-item {
    display: flex;
    align-items: center;
    padding: 8px;
    background: white;
    border-radius: 4px;
    border: 1px solid #eee;
  }
  .reason-item input {
    margin-right: 8px;
  }
  .reason-text {
    flex: 1;
  }
  .response-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  .response-btn {
    padding: 8px 15px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
  }
  .response-btn:hover {
    background: #45a049;
  }
  .response-btn.evidence {
    background: #2196F3;
  }
  .response-btn.evidence:hover {
    background: #0b7dda;
  }
  .response-btn.no-evidence {
    background: #f44336;
  }
  .response-btn.no-evidence:hover {
    background: #d32f2f;
  }
  .response-btn.driver {
    background: #FF9800;
  }
  .response-btn.driver:hover {
    background: #e68900;
  }
  .dispute-table {
    margin-top: 20px;
  }
  .action-btn {
    padding: 4px 8px;
    margin: 0 2px;
    background: #e0e0e0;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
  }
  .action-btn:hover {
    background: #d0d0d0;
  }
  .status-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }
  .status-pending {
    background: #fff3cd;
    color: #856404;
  }
  .status-approved {
    background: #d4edda;
    color: #155724;
  }
  .status-rejected {
    background: #f8d7da;
    color: #721c24;
  }
  .evidence-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }
  .evidence-available {
    background: #d4edda;
    color: #155724;
  }
  .evidence-none {
    background: #f8d7da;
    color: #721c24;
  }
  .dispute-form {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 15px;
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 10px;
  }
  .form-group {
    display: flex;
    flex-direction: column;
  }
  .form-group label {
    margin-bottom: 5px;
    font-weight: bold;
  }
  .form-group input, .form-group select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .table-container {
    overflow-x: auto;
  }
  .highlight-row {
    background-color: #fffde7 !important;
  }
  .search-box {
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 100%;
  }
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px;
    background: #4CAF50;
    color: white;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    display: none;
  }
  .notification.error {
    background: #f44336;
  }
  .notification.warning {
    background: #FF9800;
  }
  .stats-container {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .stat-card {
    background: white;
    border-radius: 5px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    flex: 1;
    min-width: 150px;
    text-align: center;
  }
  .stat-value {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 5px;
  }
  .stat-label {
    font-size: 14px;
    color: #666;
  }
  .filter-section {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 15px;
  }
  .filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 10px;
  }
  .missing-field {
    background-color: #fff8e1 !important;
    border: 1px solid #ffc107 !important;
  }
  .required-indicator {
    color: #f44336;
    margin-right: 3px;
  }
</style>
</head>
<body>
<h1>Dispute Email Management Template — Crispy Chicken</h1>
<p class="small">Paste the dispute email in the box below, then click "Extract & Add". The record will appear in the table and can be downloaded as CSV. An Arabic and English apology draft reply is automatically generated.</p>

<div class="stats-container">
  <div class="stat-card">
    <div class="stat-value" id="totalDisputes">0</div>
    <div class="stat-label">Total Disputes</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="pendingDisputes">0</div>
    <div class="stat-label">Pending</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="approvedDisputes">0</div>
    <div class="stat-label">Approved</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="rejectedDisputes">0</div>
    <div class="stat-label">Rejected</div>
  </div>
  <div class="stat-card">
    <div class="stat-value" id="totalRefunded">0</div>
    <div class="stat-label">Total Refunded</div>
  </div>
</div>

<div class="filter-section">
  <h3>Filter Disputes</h3>
  <div class="filter-grid">
    <div class="form-group">
      <label for="filterPlatform">Platform:</label>
      <select id="filterPlatform">
        <option value="">All</option>
        <option value="Noon">Noon</option>
        <option value="Careem">Careem</option>
        <option value="Talabat">Talabat</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="form-group">
      <label for="filterStatus">Status:</label>
      <select id="filterStatus">
        <option value="">All</option>
        <option value="Pending">Pending</option>
        <option value="Approved">Approved</option>
        <option value="Rejected">Rejected</option>
      </select>
    </div>
    <div class="form-group">
      <label for="filterEvidence">Evidence:</label>
      <select id="filterEvidence">
        <option value="">All</option>
        <option value="None">No Evidence</option>
        <option value="Available">Available</option>
      </select>
    </div>
    <div class="form-group">
      <label for="searchBox">Search:</label>
      <input type="text" id="searchBox" class="search-box" placeholder="Search by Order ID, Branch, or Issue">
    </div>
  </div>
</div>

<label for="emailText">Email Text:</label>
<textarea id="emailText" placeholder="Paste the complete email content from Noon / Careem ...">Dear Noon Support Team,
I hope you are well. I am writing about Order FF9BNNCNBM02XFA(Reference: 8229, Subtotal: AED 45.00), placed at Crispy Chicken ‒ Al Barsha, Dubai on 2025-09-09 at 17:56:11.</textarea>
<div class="row controls">
  <div class="col">
    <button id="parseBtn" class="btn">Extract & Add</button>
    <button id="clearBtn" class="btn">Clear Field</button>
  </div>
  <div class="col">
    <label>Platform (optional):</label>
    <select id="platformSelect">
      <option value="">-- Auto Detect --</option>
      <option value="Noon">Noon</option>
      <option value="Careem">Careem</option>
      <option value="Talabat">Talabat</option>
      <option value="Other">Other</option>
    </select>
  </div>
  <div class="col">
    <label>Export:</label><br/>
    <button id="downloadCsv" class="btn">Download CSV</button>
    <button id="saveToLocal" class="btn">Save Locally</button>
    <button id="loadFromLocal" class="btn">Load from Storage</button>
  </div>
</div>
<h3>Dispute Details</h3>
<div class="dispute-form">
  <div class="form-grid">
    <div class="form-group">
      <label for="branchName">Branch name:</label>
      <input type="text" id="branchName" placeholder="Branch name">
    </div>
    <div class="form-group">
      <label for="orderDate">Order Date:</label>
      <input type="date" id="orderDate" placeholder="Order date">
    </div>
    <div class="form-group">
      <label for="orderNumber">Order Number:</label>
      <input type="text" id="orderNumber" placeholder="Order number">
    </div>
    <div class="form-group">
      <label for="orderReference">Order Reference:</label>
      <input type="text" id="orderReference" placeholder="Order reference">
    </div>
    <div class="form-group">
      <label for="orderSubtotal">Order Subtotal:</label>
      <input type="text" id="orderSubtotal" placeholder="Subtotal">
    </div>
    <div class="form-group">
      <label for="adjustmentAmount">Adjustment amount:<span class="required-indicator">*</span></label>
      <input type="text" id="adjustmentAmount" placeholder="Compensation amount" class="missing-field">
    </div>
    <div class="form-group">
      <label for="adjustmentReason">Adjustment reason:</label>
      <input type="text" id="adjustmentReason" placeholder="Compensation reason">
    </div>
    <div class="form-group">
      <label for="complaintId">Complaint ID:</label>
      <input type="text" id="complaintId" placeholder="Complaint ID">
    </div>
  </div>
</div>
<h3>Organized Dispute Data</h3>
<div class="table-container">
  <table id="disputeTable" class="dispute-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Platform</th>
        <th>Order ID</th>
        <th>Branch</th>
        <th>Order Date</th>
        <th>Order Reference</th>
        <th>Order Subtotal</th>
        <th>Adjustment Amount</th>
        <th>Adjustment Reason</th>
        <th>Complaint ID</th>
        <th>Issue</th>
        <th>Evidence</th>
        <th>Status</th>
        <th>Refunded</th>
        <th>Original Email</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<div class="reasons-section">
  <h3>Rejection Reasons (select one or more):</h3>
  <div class="reasons-grid" id="reasonsGrid">
    <div class="reason-item">
      <input type="checkbox" id="reason1" value="noEvidence">
      <label for="reason1" class="reason-text">Complaint without photographic evidence</label>
    </div>
    <div class="reason-item">
      <input type="checkbox" id="reason2" value="driverNegligence">
      <label for="reason2" class="reason-text">Driver negligence not restaurant responsibility</label>
    </div>
    <div class="reason-item">
      <input type="checkbox" id="reason3" value="videoEvidence">
      <label for="reason3" class="reason-text">Order delivered in full with video evidence</label>
    </div>
    <div class="reason-item">
      <input type="checkbox" id="reason4" value="itemMissing">
      <label for="reason4" class="reason-text">Item missing</label>
    </div>
    <div class="reason-item">
      <input type="checkbox" id="reason5" value="spilledDrink">
      <label for="reason5" class="reason-text">Spilled drink</label>
    </div>
    <div class="reason-item">
      <input type="checkbox" id="reason6" value="wrongOrder">
      <label for="reason6" class="reason-text">Wrong order</label>
    </div>
  </div>
</div>
<div class="response-buttons">
  <button id="evidenceBtn" class="response-btn evidence">Reply with Evidence</button>
  <button id="noEvidenceBtn" class="response-btn no-evidence">Reply based on No Evidence</button>
  <button id="driverBtn" class="response-btn driver">Reply Driver Negligence</button>
  <button id="customReplyBtn" class="response-btn">Custom Reply</button>
</div>
<h3>Reply Draft for Compensation Rejection with Reasons: Complaint without photo evidence, driver negligence not restaurant responsibility, order delivered in full with video evidence</h3>
<div class="row">
  <div class="col">
    <label>Reply in Arabic:</label>
    <textarea id="replyAr" style="height:120px"></textarea>
    <div style="margin-top:6px">
      <button id="copyAr">Copy Arabic Reply</button>
      <span id="copiedAr" class="copy-ok" style="display:none">Copied!</span>
    </div>
  </div>
  <div class="col">
    <label>Reply in English:</label>
    <textarea id="replyEn" style="height:120px"></textarea>
    <div style="margin-top:6px">
      <button id="copyEn">Copy English</button>
      <span id="copiedEn" class="copy-ok" style="display:none">Copied!</span>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
(function(){
  const emailText = document.getElementById('emailText');
  const parseBtn = document.getElementById('parseBtn');
  const disputeBody = document.querySelector('#disputeTable tbody');
  const platformSelect = document.getElementById('platformSelect');
  const replyAr = document.getElementById('replyAr');
  const replyEn = document.getElementById('replyEn');
  const reasonsGrid = document.getElementById('reasonsGrid');
  const evidenceBtn = document.getElementById('evidenceBtn');
  const noEvidenceBtn = document.getElementById('noEvidenceBtn');
  const driverBtn = document.getElementById('driverBtn');
  const customReplyBtn = document.getElementById('customReplyBtn');
  const notification = document.getElementById('notification');
  const searchBox = document.getElementById('searchBox');
  const filterPlatform = document.getElementById('filterPlatform');
  const filterStatus = document.getElementById('filterStatus');
  const filterEvidence = document.getElementById('filterEvidence');
  
  // Form elements
  const branchNameInput = document.getElementById('branchName');
  const orderDateInput = document.getElementById('orderDate');
  const orderNumberInput = document.getElementById('orderNumber');
  const orderReferenceInput = document.getElementById('orderReference');
  const orderSubtotalInput = document.getElementById('orderSubtotal');
  const adjustmentAmountInput = document.getElementById('adjustmentAmount');
  const adjustmentReasonInput = document.getElementById('adjustmentReason');
  const complaintIdInput = document.getElementById('complaintId');
  
  let disputes = [];
  let currentDispute = null;
  let filteredDisputes = [];
  
  // Sample dispute data
  const sampleDispute = {
    platform: 'Noon',
    orderId: 'FF9ANN275917YZA',
    branch: 'Crispy Chicken - Al Barsha',
    orderDate: '2025-09-10',
    orderReference: '2199',
    orderSubtotal: '30.00',
    adjustmentAmount: 'a',
    adjustmentReason: 'Wrong order or item delivered - Outlet',
    complaintId: 'COMP12345',
    issue: 'Wrong order or item delivered',
    evidence: 'None',
    status: 'Pending',
    refunded: '',
    original: '',
    id: Date.now()
  };
  
  // Reasons data with Arabic and English responses
  const reasonsData = {
    noEvidence: {
      ar: "الشكوى مقدمة بدون أي إثبات صوري يوضح وجود مشكلة في الطلب.",
      en: "The complaint was submitted without any photographic evidence showing an issue with the order."
    },
    driverNegligence: {
      ar: "أي إهمال من جانب السائق أثناء التوصيل لا يعتبر مسؤولية المطعم.",
      en: "Any negligence by the driver during delivery is not the restaurant's responsibility."
    },
    videoEvidence: {
      ar: "تم تسليم الطلب بالكامل للسائق مع وجود فيديو يوضح عملية التسليم كاملة.",
      en: "The order was fully delivered to the driver with video evidence showing the complete handover process."
    },
    itemMissing: {
      ar: "الطلب تم تجهيزه بالكامل وفقاً للطلب الأصلي، ولم يفقد أي صنف.",
      en: "The order was prepared completely according to the original request, and no items were missing."
    },
    spilledDrink: {
      ar: "المشروبات تم تعبئتها بإحكام وأغلقت بشكل صحيح، وأي تسرب يحدث أثناء التوصيل يعتبر مسؤولية السائق.",
      en: "Drinks were sealed tightly and closed properly, any spillage during delivery is the driver's responsibility."
    },
    wrongOrder: {
      ar: "الطلب تم تجهيزه بالضبط حسب الطلب المسجل في النظام، وأي خطأ في التسليم يرجع للسائق.",
      en: "The order was prepared exactly as recorded in the system, any delivery error is the driver's responsibility."
    }
  };
  
  // Enhanced extraction functions
  function extractFields(text){
    const lower = text.toLowerCase();
    const result = {
      platform: '',
      order: '',
      branch: '',
      date: '',
      amount: '',
      complaint: '',
      issue: '',
      original: text.trim(),
      orderReference: '',
      orderSubtotal: '',
      adjustmentReason: '',
      customerName: '',
      customerPhone: '',
      items: []
    };
    
    // Platform
    if(lower.includes('noon')) result.platform = 'Noon';
    if(lower.includes('careem')) result.platform = 'Careem';
    if(lower.includes('talabat')) result.platform = 'Talabat';
    
    // Order number - enhanced patterns
    const orderPatterns = [
      /Order\s*(Number|No|#)?\s*[:\-]?\s*([A-Z0-9\-]{5,30})/i,
      /Order\s*Reference\s*[:\-]?\s*([0-9A-Z\-]{3,30})/i,
      /Order\s*[:\-]\s*([0-9A-Z\-]{3,30})/i,
      /\b([A-Z]{2}\d{4,}[A-Z0-9]*)\b/, // e.g. FF5QNNDQ...
      /\b(order\s*#\s*\d{3,10})/i,
      /\bRef[:\s]*([0-9A-Z\-]{3,30})\b/i,
      /\bID[:\s]*([0-9A-Z\-]{3,30})\b/i
    ];
    
    for(const p of orderPatterns){
      const mm = text.match(p);
      if(mm){
        const val = mm[2] || mm[1];
        if(val) { 
          result.order = val.trim(); 
          break; 
        }
      }
    }
    
    // Branch - enhanced patterns
    const b = text.match(/Branch\s*(name)?\s*[:\-]?\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(b) result.branch = b[2].trim();
    
    const out = text.match(/Outlet\s*[:\-]?\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(out && !result.branch) result.branch = out[1].trim();
    
    const loc = text.match(/Location\s*[:\-]?\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(loc && !result.branch) result.branch = loc[1].trim();
    
    // New pattern for "placed at"
    const placedAt = text.match(/placed at\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(placedAt && !result.branch) result.branch = placedAt[1].trim();
    
    // Date - enhanced patterns
    const d = text.match(/(\d{4}-\d{2}-\d{2})|(\d{2}\/\d{2}\/\d{4})|(\d{4}\/\d{2}\/\d{2})/);
    if(d) result.date = d[0];
    
    // Date with time pattern
    const dateTimeMatch = text.match(/(\d{4}-\d{2}-\d{2})\s*at\s*(\d{2}:\d{2}:\d{2})/);
    if(dateTimeMatch) {
      result.date = dateTimeMatch[1];
    }
    
    // Amount - enhanced patterns
    const a = text.match(/([AED]{1,3}\s*[\d,]+(?:\.\d{1,2})?)|([\d,]+(?:\.\d{1,2})?\s*(AED|Aed|aed|د.إ|درهم))/i);
    if(a) result.amount = a[0].replace(/[:,]/g,'').trim();
    
    // Adjustment amount - if explicitly mentioned and valid
    const adjAmountMatch = text.match(/Adjustment amount\s*[:\-]?\s*([AED\s]*[\d,]+(?:\.\d{1,2})?)/i);
    if(adjAmountMatch) {
      result.amount = adjAmountMatch[1].trim();
    }
    
    // Complaint ID - enhanced patterns
    const c = text.match(/(Complaint|Report|Complaint ID|Customer Complaint|Ticket ID)\s*[:\-]?\s*([A-Z0-9\-]{2,30})/i);
    if(c) result.complaint = (c[2]||c[1]).trim();
    
    // Order Reference
    const ref = text.match(/(Reference|Ref)\s*[:\-]?\s*([A-Z0-9\-]{3,30})/i);
    if(ref) result.orderReference = ref[2].trim();
    
    // Order Subtotal
    const sub = text.match(/(Subtotal|Total)\s*[:\-]?\s*([AED\s]*[\d,]+(?:\.\d{1,2})?)/i);
    if(sub) result.orderSubtotal = sub[2].trim();
    
    // Adjustment Reason
    const adj = text.match(/(Adjustment reason|Reason|Issue)\s*[:\-]?\s*([A-Za-z\u0600-\u06FF0-9 \-']{2,50})/i);
    if(adj) result.adjustmentReason = adj[2].trim();
    
    // Customer Name
    const name = text.match(/(Customer|Client|Name)\s*[:\-]?\s*([A-Za-z\u0600-\u06FF\s]{2,30})/i);
    if(name) result.customerName = name[2].trim();
    
    // Customer Phone
    const phone = text.match(/(Phone|Mobile|Contact)\s*[:\-]?\s*(\+?\d{10,15})/i);
    if(phone) result.customerPhone = phone[2].trim();
    
    // Items - extract items
    const itemsSection = text.match(/Items\s*[:\-]?\s*(.*?)(?=\n\n|\n[A-Z]|$)/is);
    if(itemsSection) {
      const itemsList = itemsSection[1].split('\n').filter(item => item.trim());
      result.items = itemsList.map(item => item.trim());
    }
    
    // Issue - enhanced patterns
    const issueMatch = text.match(/(missing item[s]?|missing|not delivered|wrong item|cold|late|delayed|short|shortage|overcharged|refund|deduction|adjustment|compensation|damaged|stale|spoiled|burnt|incorrect|incomplete)/i);
    if(issueMatch){
      const im = issueMatch[0];
      const idx = text.indexOf(im);
      const start = Math.max(0, idx - 30);
      const snippet = text.substring(start, idx + im.length + 30).replace(/\s+/g,' ').trim();
      result.issue = snippet;
    } else {
      // fallback: first line or subject-like
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
      if(lines.length) result.issue = lines.slice(0,2).join(' / ');
    }
    
    // A final attempt: if order not found, capture any token like REF/OrderRef numbers
    if(!result.order){
      const ord = text.match(/\b([0-9]{3,10})\b/);
      if(ord) result.order = ord[1];
    }
    
    return result;
  }
  
  function populateForm(fields) {
    branchNameInput.value = fields.branch || '';
    orderDateInput.value = fields.date || '';
    orderNumberInput.value = fields.order || '';
    orderReferenceInput.value = fields.orderReference || '';
    orderSubtotalInput.value = fields.orderSubtotal || '';
    adjustmentAmountInput.value = fields.amount || '';
    adjustmentReasonInput.value = fields.adjustmentReason || '';
    complaintIdInput.value = fields.complaint || '';
    
    // Highlight missing fields
    if (!fields.amount) {
      adjustmentAmountInput.classList.add('missing-field');
    } else {
      adjustmentAmountInput.classList.remove('missing-field');
    }
  }
  
  function getFormData() {
    return {
      branch: branchNameInput.value,
      date: orderDateInput.value,
      order: orderNumberInput.value,
      orderReference: orderReferenceInput.value,
      orderSubtotal: orderSubtotalInput.value,
      amount: adjustmentAmountInput.value,
      adjustmentReason: adjustmentReasonInput.value,
      complaint: complaintIdInput.value
    };
  }
  
  function showNotification(message, type = 'success') {
    notification.textContent = message;
    notification.className = 'notification';
    if (type === 'error') notification.classList.add('error');
    if (type === 'warning') notification.classList.add('warning');
    notification.style.display = 'block';
    
    setTimeout(() => {
      notification.style.display = 'none';
    }, 3000);
  }
  
  function validateForm() {
    if (!orderNumberInput.value.trim()) {
      showNotification('Order number is required', 'error');
      return false;
    }
    if (!branchNameInput.value.trim()) {
      showNotification('Branch name is required', 'error');
      return false;
    }
    if (!adjustmentAmountInput.value.trim()) {
      showNotification('Compensation amount is required', 'error');
      adjustmentAmountInput.classList.add('missing-field');
      adjustmentAmountInput.focus();
      return false;
    }
    return true;
  }
  
  function addEntry(fields){
    // Get form data
    const formData = getFormData();
    
    // Validate form
    if (!validateForm()) return;
    
    // Create dispute record
    const dispute = {
      platform: fields.platform || '',
      orderId: formData.order || fields.order || '',
      branch: formData.branch || fields.branch || '',
      orderDate: formData.date || fields.date || '',
      orderReference: formData.orderReference || fields.orderReference || '',
      orderSubtotal: formData.orderSubtotal || fields.orderSubtotal || '',
      adjustmentAmount: formData.amount || fields.amount || '',
      adjustmentReason: formData.adjustmentReason || fields.adjustmentReason || '',
      complaintId: formData.complaint || fields.complaint || '',
      issue: fields.issue || '',
      evidence: 'None', // Default value
      status: 'Pending', // Default status
      refunded: '', // Initially empty
      original: fields.original || '',
      customerName: fields.customerName || '',
      customerPhone: fields.customerPhone || '',
      items: fields.items || [],
      id: Date.now() // Unique ID for actions
    };
    
    disputes.push(dispute);
    currentDispute = dispute;
    
    // Save to localStorage
    saveToLocalStorage();
    
    renderDisputeTable();
    updateStats();
    generateReply(fields);
    
    showNotification('Dispute added successfully');
  }
  
  function renderDisputeTable(){
    disputeBody.innerHTML = '';
    
    // Apply filters
    filteredDisputes = disputes.filter(dispute => {
      // Platform filter
      if (filterPlatform.value && dispute.platform !== filterPlatform.value) {
        return false;
      }
      
      // Status filter
      if (filterStatus.value && dispute.status !== filterStatus.value) {
        return false;
      }
      
      // Evidence filter
      if (filterEvidence.value && dispute.evidence !== filterEvidence.value) {
        return false;
      }
      
      // Search filter
      if (searchBox.value.trim()) {
        const searchTerm = searchBox.value.toLowerCase();
        const searchableText = [
          dispute.orderId,
          dispute.branch,
          dispute.issue,
          dispute.adjustmentReason,
          dispute.complaintId
        ].join(' ').toLowerCase();
        
        if (!searchableText.includes(searchTerm)) {
          return false;
        }
      }
      
      return true;
    });
    
    filteredDisputes.forEach((dispute, i) => {
      const tr = document.createElement('tr');
      
      // Determine status badge class
      let statusClass = 'status-pending';
      if (dispute.status === 'Approved') statusClass = 'status-approved';
      else if (dispute.status === 'Rejected') statusClass = 'status-rejected';
      
      // Determine evidence badge class
      let evidenceClass = 'evidence-none';
      if (dispute.evidence === 'Available') evidenceClass = 'evidence-available';
      
      // Check if this is the sample dispute
      if (dispute.orderId === 'FF9ANN275917YZA') {
        tr.classList.add('highlight-row');
      }
      
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${dispute.platform}</td>
        <td>${dispute.orderId}</td>
        <td>${dispute.branch}</td>
        <td>${dispute.orderDate}</td>
        <td>${dispute.orderReference}</td>
        <td>${dispute.orderSubtotal}</td>
        <td>${dispute.adjustmentAmount || '<span style="color:#f44336">Missing</span>'}</td>
        <td style="text-align:left">${dispute.adjustmentReason}</td>
        <td>${dispute.complaintId}</td>
        <td style="text-align:left">${dispute.issue}</td>
        <td><span class="evidence-badge ${evidenceClass}">${dispute.evidence}</span></td>
        <td><span class="status-badge ${statusClass}">${dispute.status}</span></td>
        <td>${dispute.refunded}</td>
        <td style="text-align:left"><small>${(dispute.original||'').slice(0,100).replace(/\\n/g,' ')}${(dispute.original && dispute.original.length>100)?' ...':''}</small></td>
        <td>
          <button class="action-btn" onclick="viewDetails(${dispute.id})">View</button>
          <button class="action-btn" onclick="editDispute(${dispute.id})">Edit</button>
          <button class="action-btn" onclick="updateStatus(${dispute.id})">Status</button>
          <button class="action-btn" onclick="deleteDispute(${dispute.id})">Delete</button>
        </td>
      `;
      disputeBody.appendChild(tr);
    });
  }
  
  function updateStats() {
    const total = disputes.length;
    const pending = disputes.filter(d => d.status === 'Pending').length;
    const approved = disputes.filter(d => d.status === 'Approved').length;
    const rejected = disputes.filter(d => d.status === 'Rejected').length;
    
    // Calculate total refunded amount
    let totalRefunded = 0;
    disputes.forEach(d => {
      if (d.refunded) {
        const amount = parseFloat(d.refunded.replace(/[^\d.-]/g, ''));
        if (!isNaN(amount)) {
          totalRefunded += amount;
        }
      }
    });
    
    document.getElementById('totalDisputes').textContent = total;
    document.getElementById('pendingDisputes').textContent = pending;
    document.getElementById('approvedDisputes').textContent = approved;
    document.getElementById('rejectedDisputes').textContent = rejected;
    document.getElementById('totalRefunded').textContent = totalRefunded.toFixed(2) + ' AED';
  }
  
  function generateReply(f){
    // Get selected reasons
    const selectedReasons = [];
    const checkboxes = reasonsGrid.querySelectorAll('input[type="checkbox"]:checked');
    
    checkboxes.forEach(checkbox => {
      selectedReasons.push({
        id: checkbox.value,
        ar: reasonsData[checkbox.value].ar,
        en: reasonsData[checkbox.value].en
      });
    });
    
    // If no reason selected, use default reasons
    if (selectedReasons.length === 0) {
      selectedReasons.push(
        { id: 'noEvidence', ar: reasonsData.noEvidence.ar, en: reasonsData.noEvidence.en },
        { id: 'driverNegligence', ar: reasonsData.driverNegligence.ar, en: reasonsData.driverNegligence.en },
        { id: 'videoEvidence', ar: reasonsData.videoEvidence.ar, en: reasonsData.videoEvidence.en }
      );
    }
    
    // Build reasons text
    const reasonsArText = selectedReasons.map((r, i) => `${i+1}. ${r.ar}`).join('\n');
    const reasonsEnText = selectedReasons.map((r, i) => `${i+1}. ${r.en}`).join('\n');
    
    // Get form data
    const formData = getFormData();
    
    // Arabic template - Updated for rejection with reasons
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${f.issue ? ' ' + f.issue : ' الشكوى'}${formData.order ? ' (رقم الطلب: ' + formData.order + ')' : ''}${formData.branch ? ' - فرع: ' + formData.branch : ''} للأسباب التالية:
${reasonsArText}
نطالب بإلغاء التعويض المطلوب (${formData.amount || ''}) فوراً نظراً لعدم صحة الشكوى.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    // English template - Updated for rejection with reasons
    const en = `Hello,
We reject the compensation request regarding${f.issue ? ' ' + f.issue : ' the complaint'}${formData.order ? ' (Order No: ' + formData.order + ')' : ''}${formData.branch ? ' - Branch: ' + formData.branch : ''} for the following reasons:
${reasonsEnText}
We demand the immediate cancellation of the requested compensation (${formData.amount || ''}) as the complaint is invalid.
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Generate response with evidence
  function generateEvidenceResponse() {
    if (!currentDispute) {
      showNotification('Please add an email first', 'warning');
      return;
    }
    
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${currentDispute.issue ? ' ' + currentDispute.issue : ' الشكوى'}${currentDispute.orderId ? ' (رقم الطلب: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - فرع: ' + currentDispute.branch : ''} للأسباب التالية:
1. نحن نمتلك أدلة قاطعة تثبت أن الطلب تم تجهيزه وتسليمه بشكل صحيح وكامل.
2. تم تصوير عملية التغليف والتسليم بالكامل، والفيديو يوضح عدم وجود أي مشكلة في الطلب.
3. جميع الأصناف المطلوبة تم تجهيزها بدقة وفقًا لطلب العميل.
نطالب بإلغاء التعويض المطلوب (${currentDispute.adjustmentAmount || ''}) فوراً نظراً لوجود أدلة تثبت عدم صحة الشكوى.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    const en = `Hello,
We reject the compensation request regarding${currentDispute.issue ? ' ' + currentDispute.issue : ' the complaint'}${currentDispute.orderId ? ' (Order No: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - Branch: ' + currentDispute.branch : ''} for the following reasons:
1. We have conclusive evidence proving that the order was prepared and delivered correctly and completely.
2. The entire packaging and delivery process was recorded, and the video clearly shows no issues with the order.
3. All requested items were prepared accurately according to the customer's request.
We demand the immediate cancellation of the requested compensation (${currentDispute.adjustmentAmount || ''}) as we have evidence proving the complaint is invalid.
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Generate response based on lack of customer evidence
  function generateNoEvidenceResponse() {
    if (!currentDispute) {
      showNotification('Please add an email first', 'warning');
      return;
    }
    
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${currentDispute.issue ? ' ' + currentDispute.issue : ' الشكوى'}${currentDispute.orderId ? ' (رقم الطلب: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - فرع: ' + currentDispute.branch : ''} للأسباب التالية:
1. العميل لم يقدم أي دليل أو إثبات يدعم ادعاءاته حول وجود مشكلة في الطلب.
2. وفقًا لسياسة المنصة، يجب تقديم أدلة واضحة (صور أو فيديو) لإثبات وجود مشكلة في الطلب.
3. بدون إثباتات، لا يمكن التحقق من صحة الشكوى وبالتالي يتم رفضها.
نطالب بإلغاء التعويض المطلوب (${currentDispute.adjustmentAmount || ''}) فوراً نظراً لعدم وجود أدلة تدعم الشكوى.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    const en = `Hello,
We reject the compensation request regarding${currentDispute.issue ? ' ' + currentDispute.issue : ' the complaint'}${currentDispute.orderId ? ' (Order No: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - Branch: ' + currentDispute.branch : ''} for the following reasons:
1. The customer did not provide any evidence or proof to support their claims about an issue with the order.
2. According to platform policy, clear evidence (photos or videos) must be provided to prove an issue with the order.
3. Without evidence, the validity of the complaint cannot be verified and therefore it is rejected.
We demand the immediate cancellation of the requested compensation (${currentDispute.adjustmentAmount || ''}) as there is no evidence supporting the complaint.
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Generate response for driver negligence
  function generateDriverResponse() {
    if (!currentDispute) {
      showNotification('Please add an email first', 'warning');
      return;
    }
    
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${currentDispute.issue ? ' ' + currentDispute.issue : ' الشكوى'}${currentDispute.orderId ? ' (رقم الطلب: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - فرع: ' + currentDispute.branch : ''} للأسباب التالية:
1. الطلب تم تجهيزه بالكامل وبشكل صحيح في المطعم وفقًا لطلب العميل.
2. تم تسليم الطلب للسائق بشكل كامل وسليم، وأي مشكلة حدثت بعد ذلك تعتبر مسؤولية السائق.
3. إهمال السائق أثناء التوصيل أو سوء التعامل مع الطلب لا يعتبر مسؤولية المطعم.
نطالب بإلغاء التعويض المطلوب (${currentDispute.adjustmentAmount || ''}) فوراً نظراً لأن المشكلة حدثت بسبب إهمال السائق وليس خطأ من المطعم.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    const en = `Hello,
We reject the compensation request regarding${currentDispute.issue ? ' ' + currentDispute.issue : ' the complaint'}${currentDispute.orderId ? ' (Order No: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - Branch: ' + currentDispute.branch : ''} for the following reasons:
1. The order was prepared completely and correctly at the restaurant according to the customer's request.
2. The order was handed over to the driver in full and good condition, any issues that occurred afterward are the driver's responsibility.
3. Driver negligence during delivery or mishandling of the order is not the restaurant's responsibility.
We demand the immediate cancellation of the requested compensation (${currentDispute.adjustmentAmount || ''}) as the issue was caused by driver negligence, not the restaurant's fault.
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Generate custom response
  function generateCustomResponse() {
    if (!currentDispute) {
      showNotification('Please add an email first', 'warning');
      return;
    }
    
    const customReason = prompt('Enter custom rejection reason:');
    if (!customReason) return;
    
    const ar = `السلام عليكم،
نرفض طلب التعويض المقدم بخصوص${currentDispute.issue ? ' ' + currentDispute.issue : ' الشكوى'}${currentDispute.orderId ? ' (رقم الطلب: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - فرع: ' + currentDispute.branch : ''} للسبب التالي:
${customReason}
نطالب بإلغاء التعويض المطلوب (${currentDispute.adjustmentAmount || ''}) فوراً.
مع تحيات،
فريق خدمة العملاء - Crispy Chicken
هاتف التوصيل: 600-527-488`;
    
    const en = `Hello,
We reject the compensation request regarding${currentDispute.issue ? ' ' + currentDispute.issue : ' the complaint'}${currentDispute.orderId ? ' (Order No: ' + currentDispute.orderId + ')' : ''}${currentDispute.branch ? ' - Branch: ' + currentDispute.branch : ''} for the following reason:
${customReason}
We demand the immediate cancellation of the requested compensation (${currentDispute.adjustmentAmount || ''}).
Best regards,
Customer Service - Crispy Chicken
Delivery Hotline: 600-527-488`;
    
    replyAr.value = ar;
    replyEn.value = en;
  }
  
  // Local Storage Functions
  function saveToLocalStorage() {
    try {
      localStorage.setItem('crispyDisputes', JSON.stringify(disputes));
      showNotification('Data saved locally');
    } catch (e) {
      showNotification('Failed to save data: ' + e.message, 'error');
    }
  }
  
  function loadFromLocalStorage() {
    try {
      const saved = localStorage.getItem('crispyDisputes');
      if (saved) {
        disputes = JSON.parse(saved);
        renderDisputeTable();
        updateStats();
        showNotification('Data loaded from local storage');
      } else {
        showNotification('No saved data found', 'warning');
      }
    } catch (e) {
      showNotification('Failed to load data: ' + e.message, 'error');
    }
  }
  
  // Action functions for dispute table
  window.viewDetails = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (dispute) {
      let details = `Dispute Details:\n\n`;
      details += `Order Number: ${dispute.orderId}\n`;
      details += `Date: ${dispute.orderDate}\n`;
      details += `Branch: ${dispute.branch}\n`;
      details += `Platform: ${dispute.platform}\n`;
      details += `Issue: ${dispute.issue}\n`;
      details += `Compensation: ${dispute.adjustmentAmount || 'Missing'}\n`;
      details += `Reference: ${dispute.orderReference}\n`;
      details += `Subtotal: ${dispute.orderSubtotal}\n`;
      details += `Compensation Reason: ${dispute.adjustmentReason}\n`;
      details += `Complaint ID: ${dispute.complaintId}\n`;
      details += `Evidence Status: ${dispute.evidence}\n`;
      details += `Status: ${dispute.status}\n`;
      details += `Refunded Amount: ${dispute.refunded}\n`;
      
      if (dispute.customerName) details += `Customer Name: ${dispute.customerName}\n`;
      if (dispute.customerPhone) details += `Customer Phone: ${dispute.customerPhone}\n`;
      if (dispute.items.length > 0) details += `Items: ${dispute.items.join(', ')}\n`;
      
      alert(details);
    }
  };
  
  window.editDispute = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (dispute) {
      // Populate form with dispute data
      populateForm(dispute);
      
      // Set as current dispute
      currentDispute = dispute;
      
      // Generate reply for this dispute
      generateReply(dispute);
      
      showNotification('Dispute data loaded in the form above. You can modify the data and then create a new reply.');
    }
  };
  
  window.updateStatus = function(id) {
    const dispute = disputes.find(d => d.id === id);
    if (dispute) {
      const newStatus = prompt('Update dispute status (Pending/Approved/Rejected):', dispute.status);
      if (newStatus && (newStatus === 'Pending' || newStatus === 'Approved' || newStatus === 'Rejected')) {
        dispute.status = newStatus;
        saveToLocalStorage();
        renderDisputeTable();
        updateStats();
      }
      
      const newEvidence = prompt('Update evidence status (None/Available):', dispute.evidence);
      if (newEvidence && (newEvidence === 'None' || newEvidence === 'Available')) {
        dispute.evidence = newEvidence;
        saveToLocalStorage();
        renderDisputeTable();
      }
      
      const refunded = prompt('Enter refunded amount (if any):', dispute.refunded);
      if (refunded !== null) {
        dispute.refunded = refunded;
        saveToLocalStorage();
        renderDisputeTable();
        updateStats();
      }
    }
  };
  
  window.deleteDispute = function(id) {
    if (confirm('Are you sure you want to delete this dispute?')) {
      disputes = disputes.filter(d => d.id !== id);
      saveToLocalStorage();
      renderDisputeTable();
      updateStats();
      
      if (currentDispute && currentDispute.id === id) {
        currentDispute = null;
      }
      
      showNotification('Dispute deleted successfully');
    }
  };
  
  parseBtn.addEventListener('click', ()=>{
    const txt = emailText.value.trim();
    if(!txt){ 
      showNotification('Please paste the email text first.', 'error');
      return; 
    }
    const parsed = extractFields(txt);
    // If user selected platform manually, override
    if(platformSelect.value) parsed.platform = platformSelect.value;
    
    // Populate form with extracted data
    populateForm(parsed);
    
    // Check if adjustment amount is missing
    if (!parsed.amount) {
      showNotification('Compensation amount is missing, please enter it manually', 'warning');
      adjustmentAmountInput.focus();
    }
    
    addEntry(parsed);
    // clear input for next
    emailText.value = '';
  });
  
  document.getElementById('clearBtn').addEventListener('click', ()=>{ 
    emailText.value = ''; 
    showNotification('Field cleared');
  });
  
  // CSV download
  document.getElementById('downloadCsv').addEventListener('click', ()=>{
    if(disputes.length===0){ 
      showNotification('No data to download.', 'warning');
      return; 
    }
    
    // Helper function to format CSV fields
    function formatCsvField(field) {
      if (field === null || field === undefined) return '';
      field = field.toString();
      if (field.includes(',') || field.includes('\n') || field.includes('"')) {
        return '"' + field.replace(/"/g, '""') + '"';
      }
      return field;
    }
    
    const headers = ['#', 'Platform', 'Order ID', 'Branch', 'Order Date', 'Order Reference', 'Order Subtotal', 'Adjustment Amount', 'Adjustment Reason', 'Complaint ID', 'Issue', 'Evidence', 'Status', 'Refunded', 'Customer Name', 'Customer Phone', 'Items', 'Original Email'];
    const formattedHeaders = headers.map(h => formatCsvField(h));
    
    const rows = disputes.map((dispute, i) => [
      formatCsvField(i+1),
      formatCsvField(dispute.platform),
      formatCsvField(dispute.orderId),
      formatCsvField(dispute.branch),
      formatCsvField(dispute.orderDate),
      formatCsvField(dispute.orderReference),
      formatCsvField(dispute.orderSubtotal),
      formatCsvField(dispute.adjustmentAmount),
      formatCsvField(dispute.adjustmentReason),
      formatCsvField(dispute.complaintId),
      formatCsvField(dispute.issue),
      formatCsvField(dispute.evidence),
      formatCsvField(dispute.status),
      formatCsvField(dispute.refunded),
      formatCsvField(dispute.customerName),
      formatCsvField(dispute.customerPhone),
      formatCsvField(dispute.items.join('; ')),
      formatCsvField((dispute.original || '').replace(/\r?\n/g, ' '))
    ]);
    
    const csv = [formattedHeaders.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'disputes_sheet.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    
    showNotification('CSV file downloaded successfully');
  });
  
  // Local Storage buttons
  document.getElementById('saveToLocal').addEventListener('click', saveToLocalStorage);
  document.getElementById('loadFromLocal').addEventListener('click', loadFromLocalStorage);
  
  // copy buttons
  document.getElementById('copyAr').addEventListener('click', ()=>{
    navigator.clipboard.writeText(replyAr.value).then(()=>{
      const el = document.getElementById('copiedAr');
      el.style.display = 'inline';
      setTimeout(()=>el.style.display='none',2000);
      showNotification('Arabic reply copied');
    });
  });
  
  document.getElementById('copyEn').addEventListener('click', ()=>{
    navigator.clipboard.writeText(replyEn.value).then(()=>{
      const el = document.getElementById('copiedEn');
      el.style.display = 'inline';
      setTimeout(()=>el.style.display='none',2000);
      showNotification('English reply copied');
    });
  });
  
  // Allow double-click on table row to edit reply using that entry
  disputeBody.addEventListener('dblclick', (ev)=>{
    let tr = ev.target.closest('tr');
    if(!tr) return;
    const idx = parseInt(tr.children[0].textContent,10)-1;
    if(disputes[idx]) {
      currentDispute = disputes[idx];
      
      // Populate form with entry data
      populateForm(disputes[idx]);
      
      generateReply(disputes[idx]);
      showNotification('Data from this record loaded in reply drafts above. Edit the text then copy to send.');
    }
  });
  
  // Update reply when reasons are selected
  reasonsGrid.addEventListener('change', () => {
    if (currentDispute) {
      generateReply(currentDispute);
    }
  });
  
  // Response buttons event listeners
  evidenceBtn.addEventListener('click', generateEvidenceResponse);
  noEvidenceBtn.addEventListener('click', generateNoEvidenceResponse);
  driverBtn.addEventListener('click', generateDriverResponse);
  customReplyBtn.addEventListener('click', generateCustomResponse);
  
  // Filter event listeners
  searchBox.addEventListener('input', renderDisputeTable);
  filterPlatform.addEventListener('change', renderDisputeTable);
  filterStatus.addEventListener('change', renderDisputeTable);
  filterEvidence.addEventListener('change', renderDisputeTable);
  
  // Form input event listeners to update current dispute
  branchNameInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.branch = branchNameInput.value;
    }
  });
  
  orderDateInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.orderDate = orderDateInput.value;
    }
  });
  
  orderNumberInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.orderId = orderNumberInput.value;
    }
  });
  
  orderReferenceInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.orderReference = orderReferenceInput.value;
    }
  });
  
  orderSubtotalInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.orderSubtotal = orderSubtotalInput.value;
    }
  });
  
  adjustmentAmountInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.adjustmentAmount = adjustmentAmountInput.value;
    }
    // Remove highlight when user enters a value
    if (adjustmentAmountInput.value.trim()) {
      adjustmentAmountInput.classList.remove('missing-field');
    }
  });
  
  adjustmentReasonInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.adjustmentReason = adjustmentReasonInput.value;
    }
  });
  
  complaintIdInput.addEventListener('input', () => {
    if (currentDispute) {
      currentDispute.complaintId = complaintIdInput.value;
    }
  });
  
  // Initialize with sample data
  function initializeSampleData() {
    // Add sample dispute to the list
    disputes.push(sampleDispute);
    currentDispute = sampleDispute;
    
    // Populate form with sample data
    populateForm(sampleDispute);
    
    // Render the table
    renderDisputeTable();
    updateStats();
    
    // Generate a default reply
    generateReply(sampleDispute);
  }
  
  // Initialize the page with sample data
  initializeSampleData();
  
  // Auto-parse the pre-filled email on page load
  window.addEventListener('load', () => {
    if (emailText.value.trim()) {
      const parsed = extractFields(emailText.value);
      populateForm(parsed);
      
      // Check if adjustment amount is missing
      if (!parsed.amount) {
        showNotification('Compensation amount is missing, please enter it manually', 'warning');
        adjustmentAmountInput.focus();
      }
    }
  });
})();
</script>
</body>
</html>
