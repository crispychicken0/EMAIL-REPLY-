<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Email Tracker Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --primary:#2563eb;
    --success:#16a34a;
    --warning:#f59e0b;
    --danger:#dc2626;
    --expired:#6b7280;
    --bg:#f9fafb;
    --card:#ffffff;
    --text:#1f2937;
  }
  body { font-family: Arial, sans-serif; margin:0; padding:20px; background:var(--bg); color:var(--text);}
  h1 { color:var(--primary); }
  .container { display:grid; grid-template-columns: 2fr 1fr; gap:20px; }
  .card { background:var(--card); border-radius:12px; padding:20px; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
  table { width:100%; border-collapse:collapse; margin-top:10px;}
  th, td { padding:8px; border-bottom:1px solid #e5e7eb; text-align:left; }
  th { background:#f3f4f6; position:sticky; top:0; }
  button { 
    padding:4px 8px; 
    border:none; 
    border-radius:6px; 
    cursor:pointer; 
    font-size:12px;
    transition: all 0.2s ease;
    transform: scale(1);
  }
  button:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  .btn { margin-right:3px; }
  .Reply { background:var(--success); color:white; }
  .Follow-up { background:var(--warning); color:white; }
  .Closed { background:var(--danger); color:white; }
  .Expired { background:var(--expired); color:white; }
  .Delete { background:#6b7280; color:white; }
  .stat-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(120px,1fr)); gap:10px; margin-top:10px; }
  .stat-card { background:var(--card); padding:15px; border-radius:10px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
  .badge { padding:3px 8px; border-radius:12px; font-size:12px; }
  .badge.Reply { background:#dcfce7; color:#166534; }
  .badge.Follow-up { background:#fef9c3; color:#92400e; }
  .badge.Closed { background:#fee2e2; color:#991b1b; }
  .badge.Expired { background:#e5e7eb; color:#4b5563; }
  .toast { position:fixed; top:20px; right:20px; background:#333; color:#fff; padding:10px 15px; border-radius:8px; opacity:0; transform:translateY(-20px); transition:all 0.3s ease; z-index:1000;}
  .toast.show { opacity:1; transform:translateY(0); }
  input, select { padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-bottom:8px; width:100%; }
  .timer { font-size:12px; color:var(--danger); font-weight:bold; }
</style>
</head>
<body>
<h1>Email Tracker Pro</h1>

<div class="container">
  <!-- Left Side -->
  <div>
    <div class="card">
      <h3>Add New Email</h3>
      <label>Subject</label>
      <input type="text" id="subject">
      <label>From</label>
      <div style="display:flex; gap:10px;">
        <input type="text" id="from">
        <select id="contactList" onchange="fillContact()">
          <option value="">-- Select Contact --</option>
        </select>
      </div>
      <label>Date Sent</label>
      <input type="datetime-local" id="dateSent">
      <label>Priority</label>
      <select id="priority">
        <option value="High">High</option>
        <option value="Medium">Medium</option>
        <option value="Low">Low</option>
      </select>
      <label>Timer Duration</label>
      <select id="timerDuration">
        <option value="24">24 hours</option>
        <option value="48" selected>48 hours</option>
        <option value="72">72 hours</option>
      </select>
      <label>Notes</label>
      <input type="text" id="notes">
      <button onclick="addEmail()" style="background:var(--primary);color:white;">Add Email</button>
    </div>

    <div class="card" style="margin-top:20px;">
      <h3>Email Table</h3>
      <table id="emailTable">
        <thead>
          <tr>
            <th>Subject</th>
            <th>From</th>
            <th>Date Sent</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Timer</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Right Side -->
  <div>
    <div class="card">
      <h3>Contacts</h3>
      <input type="text" id="contactName" placeholder="Name">
      <input type="email" id="contactEmail" placeholder="Email">
      <button onclick="addContact()" style="background:var(--primary);color:white;">Add Contact</button>
    </div>

    <div class="card" style="margin-top:20px;">
      <h3>Dashboard</h3>
      <div class="stat-grid">
        <div class="stat-card"><h2 id="totalCount">0</h2><p>Total</p></div>
        <div class="stat-card"><h2 id="replyCount">0</h2><p>Reply</p></div>
        <div class="stat-card"><h2 id="followCount">0</h2><p>Follow-up</p></div>
        <div class="stat-card"><h2 id="closedCount">0</h2><p>Closed</p></div>
        <div class="stat-card"><h2 id="expiredCount">0</h2><p>Expired</p></div>
      </div>
      <canvas id="dashboardChart" height="200"></canvas>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
const WHATSAPP_NUMBER = "971509021993";
let emails = JSON.parse(localStorage.getItem("emails")) || [];
let contacts = JSON.parse(localStorage.getItem("contacts")) || [];
let timerInterval;

// ====== CONTACT FUNCTIONS ======
function addContact(){
  const name = document.getElementById("contactName").value.trim();
  const email = document.getElementById("contactEmail").value.trim();
  if(!name || !email){ showToast("Enter name and email","error"); return; }
  contacts.push({name,email});
  localStorage.setItem("contacts",JSON.stringify(contacts));
  renderContacts();
  document.getElementById("contactName").value="";
  document.getElementById("contactEmail").value="";
  showToast("Contact added","success");
}
function renderContacts(){
  const select = document.getElementById("contactList");
  select.innerHTML = `<option value="">-- Select Contact --</option>`;
  contacts.forEach((c,i)=>{ select.innerHTML += `<option value="${i}">${c.name} (${c.email})</option>`; });
}
function fillContact(){
  const index = document.getElementById("contactList").value;
  if(index!==""){ document.getElementById("from").value = contacts[index].email; }
}

// ====== EMAIL FUNCTIONS ======
function addEmail(){
  const subject=document.getElementById("subject").value.trim();
  const from=document.getElementById("from").value.trim();
  const dateSent=document.getElementById("dateSent").value;
  const priority=document.getElementById("priority").value;
  const timerDuration=document.getElementById("timerDuration").value;
  const notes=document.getElementById("notes").value.trim();
  if(!subject||!from||!dateSent){ showToast("Fill Subject, From, Date","error"); return; }
  
  // Calculate expiration time
  const dateSentObj = new Date(dateSent);
  const expirationTime = new Date(dateSentObj.getTime() + (timerDuration * 60 * 60 * 1000));
  
  emails.push({
    Subject:subject,
    From:from,
    "Date Sent":dateSent,
    Status:"Follow-up",
    Priority:priority,
    Notes:notes,
    TimerDuration: timerDuration,
    ExpirationTime: expirationTime.toISOString(),
    Notified: false
  });
  
  localStorage.setItem("emails",JSON.stringify(emails));
  renderTable(); 
  renderDashboard();
  
  document.getElementById("subject").value="";
  document.getElementById("from").value="";
  document.getElementById("dateSent").value="";
  document.getElementById("notes").value="";
  
  showToast("Email added","success");
  
  // Start timer if not already running
  if (!timerInterval) {
    startTimers();
  }
}
function renderTable(){
  const tbody=document.querySelector("#emailTable tbody"); 
  tbody.innerHTML="";
  
  emails.forEach((email,i)=>{
    const row=document.createElement("tr");
    
    // Calculate remaining time
    const expirationTime = new Date(email.ExpirationTime);
    const now = new Date();
    const timeDiff = expirationTime - now;
    
    let timerDisplay = "";
    if (timeDiff > 0) {
      const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
      timerDisplay = `${days}d ${hours}h ${minutes}m`;
    } else if (email.Status !== "Expired") {
      timerDisplay = "Expired";
    }
    
    row.innerHTML=`
      <td>${email.Subject}</td>
      <td>${email.From}</td>
      <td>${new Date(email['Date Sent']).toLocaleString()}</td>
      <td><span class="badge ${email.Status}">${email.Status}</span></td>
      <td>${email.Priority}</td>
      <td class="timer">${timerDisplay}</td>
      <td>${email.Notes}</td>
      <td>
        <button class="Reply btn" onclick="updateStatus(${i},'Reply')">Reply</button>
        <button class="Follow-up btn" onclick="updateStatus(${i},'Follow-up')">Follow-up</button>
        <button class="Closed btn" onclick="updateStatus(${i},'Closed')">Closed</button>
        <button class="Delete btn" onclick="deleteEmail(${i})">Delete</button>
      </td>`;
    tbody.appendChild(row);
  });
}
function updateStatus(index,newStatus){
  emails[index].Status=newStatus;
  localStorage.setItem("emails",JSON.stringify(emails));
  
  if(newStatus==="Follow-up"){
    const email=emails[index];
    const message=`Reminder: Email "${email.Subject}" from ${email.From} needs attention. Status: ${newStatus}`;
    window.open(`https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${encodeURIComponent(message)}`,"_blank");
    showToast("WhatsApp reminder sent","info");
  }
  
  renderTable(); 
  renderDashboard();
}
function deleteEmail(index){
  emails.splice(index, 1);
  localStorage.setItem("emails",JSON.stringify(emails));
  renderTable();
  renderDashboard();
  showToast("Email deleted","success");
}

// ====== TIMER FUNCTIONS ======
function startTimers() {
  timerInterval = setInterval(() => {
    let needsUpdate = false;
    
    emails.forEach((email, index) => {
      if (email.Status === "Expired") return; // Skip if already expired
      
      const expirationTime = new Date(email.ExpirationTime);
      const now = new Date();
      
      if (now >= expirationTime && !email.Notified) {
        // Mark as expired
        emails[index].Status = "Expired";
        emails[index].Notified = true;
        needsUpdate = true;
        
        // Send WhatsApp notification
        sendExpiredNotification(email);
      }
    });
    
    if (needsUpdate) {
      localStorage.setItem("emails", JSON.stringify(emails));
      renderTable();
      renderDashboard();
    }
    
    // Update timer displays
    renderTable();
  }, 60000); // Check every minute
}
function sendExpiredNotification(email) {
  // Find contact name if available
  let recipientName = email.From;
  const contact = contacts.find(c => c.email === email.From);
  if (contact) {
    recipientName = contact.name;
  }
  
  const message = `⏰ EXPIRED EMAIL NOTIFICATION ⏰\n\n` +
                 `Recipient: ${recipientName}\n` +
                 `Email: ${email.From}\n` +
                 `Subject: ${email.Subject}\n\n` +
                 `This email has exceeded the response time. Please take immediate action.`;
  
  window.open(`https://api.whatsapp.com/send?phone=${WHATSAPP_NUMBER}&text=${encodeURIComponent(message)}`, "_blank");
  showToast("Expired email notification sent", "warning");
}

// ====== DASHBOARD ======
function renderDashboard(){
  const counts={Reply:0,"Follow-up":0,Closed:0, Expired:0}; 
  emails.forEach(e=>{counts[e.Status]++;});
  
  document.getElementById("totalCount").innerText=emails.length;
  document.getElementById("replyCount").innerText=counts.Reply;
  document.getElementById("followCount").innerText=counts["Follow-up"];
  document.getElementById("closedCount").innerText=counts.Closed;
  document.getElementById("expiredCount").innerText=counts.Expired;
  
  const ctx=document.getElementById("dashboardChart").getContext("2d");
  if(window.dashboardChart) window.dashboardChart.destroy();
  
  window.dashboardChart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Reply","Follow-up","Closed","Expired"], 
      datasets:[{
        label:"Emails",
        data:[counts.Reply,counts["Follow-up"],counts.Closed,counts.Expired],
        backgroundColor:['#16a34a','#f59e0b','#dc2626', '#6b7280']
      }]
    },
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}

// ====== NOTIFICATIONS ======
function showToast(msg,type){
  const toast=document.getElementById("toast");
  toast.innerText=msg;
  toast.style.background= type==="success" ? "#16a34a" : type==="error" ? "#dc2626" : type==="warning" ? "#f59e0b" : "#2563eb";
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),3000);
}

// INIT
renderTable(); 
renderDashboard(); 
renderContacts();

// Start timers on page load
startTimers();

// Clean up interval on page unload
window.addEventListener('beforeunload', () => {
  if (timerInterval) {
    clearInterval(timerInterval);
  }
});
</script>
</body>
</html>
