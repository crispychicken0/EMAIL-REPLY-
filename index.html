<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dispute Email Generator — Crispy Chicken</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    input, select, textarea, button { display: block; margin: 10px 0; padding: 8px; width: 100%; max-width: 400px; }
    .btn-group button { width: auto; display: inline-block; margin-right: 10px; }
    .preview { border: 1px solid #ccc; padding: 10px; white-space: pre-wrap; margin-top: 20px; }
  </style>
</head>
<body>

<h1>Dispute Email Generator</h1>

<label>Order Number *</label>
<input id="orderId" placeholder="FF8VNNFDJ0NKJ3A">

<label>Order Date & Time *</label>
<input id="orderDate" type="datetime-local">

<label>Branch Name *</label>
<input id="branchName" placeholder="Crispy Chicken - Al Barsha">

<label>Platform *</label>
<select id="platform"><option>Careem</option><option>Noon</option></select>

<label>Basket Amount (AED)</label>
<input id="basketAmount" type="number" step="0.01" placeholder="35.00">

<label>Deducted Amount (AED)</label>
<input id="deductedAmount" type="number" step="0.01" placeholder="18.00">

<label>Dispute Reason *</label>
<select id="reason">
  <option value="Missing item">Missing item</option>
  <option value="Spilled / damaged">Spilled / damaged</option>
  <option value="Hygiene issues">Hygiene issues</option>
  <option value="Other">Other</option>
</select>

<label>Evidence Link</label>
<input id="evidenceLink" placeholder="https://...">

<label>Or Upload File</label>
<input id="evidenceFile" type="file" accept="video/*,image/*">

<div class="btn-group">
  <button id="validateBtn">Validate Evidence</button>
  <button id="uploadBtn">Upload (stub)</button>
  <button id="generate">Generate Email</button>
  <button id="genEml">Generate .eml</button>
  <button id="whatsappBtn">Send WhatsApp</button>
  <button id="copyBtn" disabled>Copy Email</button>
  <button id="downloadBtn" disabled>Download .txt</button>
</div>

<div id="status"></div>
<pre id="preview" class="preview"></pre>

<script>
function init() {
  const reasonReq = new Set(['Missing item','Spilled / damaged','Hygiene issues']);
  
  const byId = id => document.getElementById(id);

  const buildEmail = () => {
    const orderId = byId('orderId').value.trim();
    const orderDate = byId('orderDate').value;
    const branch = byId('branchName').value.trim();
    const platform = byId('platform').value;
    const basket = byId('basketAmount').value;
    const deducted = byId('deductedAmount').value;
    const reason = byId('reason').value;
    const link = byId('evidenceLink').value.trim();
    const file = byId('evidenceFile').files[0];
    const fileLine = file ? `Attached file: ${file.name}` : (link ? `Evidence link: ${link}` : 'No evidence attached');
    const subject = `Dispute: Order ${orderId} — ${reason}`;
    const body = `Dear ResOps Team,

I am writing regarding an adjustment on Order ${orderId} placed on ${new Date(orderDate).toLocaleString()} at ${branch} via ${platform}. Basket: AED ${basket}, deduction: AED ${deducted}, reason: ${reason}.

After verification, order was delivered complete. Evidence provided:
${fileLine}

Actions required:
1) Confirm receipt of evidence.
2) If no valid evidence, reverse deduction and refund AED ${deducted}.
3) Provide timeline for resolution.

Best regards,
Ahmed Kenawy
Call Center Manager | Crispy Chicken
    `;
    return {subject, body};
  };

  byId('validateBtn').onclick = () => {
    const reason = byId('reason').value;
    const link = byId('evidenceLink').value.trim();
    const file = byId('evidenceFile').files[0];
    byId('status').textContent = reasonReq.has(reason) && !link && !file
      ? '⛔ Evidence required.'
      : '✅ Ready.';
  };

  byId('generate').onclick = () => {
    const {subject, body} = buildEmail();
    byId('preview').textContent = `Subject: ${subject}\n\n${body}`;
    byId('copyBtn').disabled = false;
    byId('downloadBtn').disabled = false;
  };

  byId('genEml').onclick = () => {
    const {subject, body} = buildEmail();
    const headers = [
      'From: Crispy Chicken <kenawe@crispychicken.rest>',
      'To: resops@careem.com',
      `Subject: ${subject}`,
      'MIME-Version: 1.0',
      'Content-Type: text/plain; charset="UTF-8"'
    ];
    const eml = headers.join('\r\n') + '\r\n\r\n' + body;
    const blob = new Blob([eml], {type: 'message/rfc822'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `dispute-${byId('orderId').value || 'order'}.eml`;
    a.click();
    URL.revokeObjectURL(url);
  };

  byId('whatsappBtn').onclick = () => {
    const {body} = buildEmail();
    const phone = '971569659524';
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(body)}`, '_blank');
  };

  byId('copyBtn').onclick = async () => {
    await navigator.clipboard.writeText(byId('preview').textContent);
    alert('Email copied');
  };

  byId('downloadBtn').onclick = () => {
    const text = byId('preview').textContent;
    const blob = new Blob([text], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `dispute-${byId('orderId').value}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  byId('uploadBtn').onclick = () => alert('Upload is a placeholder—implement backend.');
}

if (document.readyState !== 'loading') {
  init();
} else {
  document.addEventListener('DOMContentLoaded', init);
}
</script>

</body>
</html>
